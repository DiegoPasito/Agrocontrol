<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoviGestf</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF para generar PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF-AutoTable para tablas bonitas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <!-- html2canvas para capturar las gr√°ficas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <link rel="stylesheet" href="css/simmental.css">

</head>
<body>
  <header>
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand">
          <img src="img/LogoAgrocontrol.png" alt="Logo Agrocontrol" width="100" height="100" onerror="this.style.display='none'">
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="contenidoPrincipal.html">Inicio</a>
            </li>

            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Vacas
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="Jersey.html">Jersey</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="Girolando.html">Girolando</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="Gyr.html">Gyr</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="simmental.html">Simmental</a></li>
              </ul>
            </li>

            <li class="nav-item">
          <a class="nav-link" href="Medicamentos.html">Medicamentos</a>
              </li>

            <li class="nav-item">
              <a class="nav-link" href="insumos.html">Insumos</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="enfermedades.html">Enfermedades</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="Alertas y recordatorios.html">Recordatorios</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="control.html">Control</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="Costos.html">Costos</a>
            </li>

            <li class="nav-item">
              <a class="nav-link" href="Perfilusuario.html">Perfil</a>
            </li>
          </ul>

          <!-- üì± BOT√ìN DESCARGAR APP (Alineado a la derecha) -->
      <div class="ms-auto">
        <button class="btn-descargar-app" data-bs-toggle="modal" data-bs-target="#modalQR">
          <span class="download-icon">üì±</span>
          <span class="download-text">Descargar App</span>
        </button>
      </div>

        </div>
      </div>
    </nav>
  </header>

  <main class="container mt-4">
    <div class="text-center mb-5">
      <h2 class="page-title">üêÑ Perfil de la Vaca Simmental</h2>
      <p class="page-subtitle">Una raza europea fuerte, productiva y de doble prop√≥sito üí™ü•õüçñ</p>
      <hr class="decorative">
    </div>
    
    <!-- Secci√≥n principal -->
    <div class="card shadow-lg mb-4">
      <div class="row g-0 align-items-center w-100 m-0">
        <div class="col-md-5">
          <img src="img/Simmental imagen 5.webp" class="img-fluid rounded-start" alt="Vaca Simmental" style="border-radius:20px 0 0 20px;" onerror="this.style.display='none'">
        </div>
        <div class="col-md-7">
          <div class="card-body">
            <h4 class="card-title fw-bold section-title">Raza Simmental</h4>
            <p class="card-text">
              <strong>Descripci√≥n:</strong> La Simmental es una raza de <strong>doble prop√≥sito</strong> (leche y carne),
              originaria del valle del r√≠o Simme en Suiza üá®üá≠.
              Es grande, musculosa y de pelaje rojizo con manchas blancas. Produce buena leche y carne de alta calidad.
            </p>
            <ul class="list-unstyled">
              <li><strong>Tama√±o:</strong> Vacas 600‚Äì700 kg, toros hasta 1.200 kg.</li>
              <li><strong>Color:</strong> Rojizo con manchas blancas, cara blanca t√≠pica.</li>
              <li><strong>Producci√≥n:</strong> 4.000‚Äì6.000 L/lactancia.</li>
              <li><strong>Grasa:</strong> 3.8‚Äì4.2%.</li>
              <li><strong>Uso:</strong> Leche y carne (doble prop√≥sito).</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Alimentaci√≥n -->
    <div class="card shadow-sm border-left-accent mb-4">
      <div class="card-body">
        <h5 class="section-title">üå± Alimentaci√≥n</h5>
        <ul>
          <li><strong>Forrajes:</strong> Kikuyo, ryegrass, estrella africana.</li>
          <li><strong>Conservados:</strong> Ensilaje de ma√≠z y sorgo.</li>
          <li><strong>Concentrados:</strong> Balanceados 16‚Äì18% prote√≠na.</li>
          <li><strong>Minerales:</strong> Calcio y f√≥sforo, por su gran tama√±o.</li>
        </ul>
      </div>
    </div>
    
    <!-- Suplementos -->
    <div class="card shadow-sm border-left-accent mb-4">
      <div class="card-body">
        <h5 class="section-title">üß™ Suplementos</h5>
        <ul>
          <li><strong>Preparto:</strong> Calcio y f√≥sforo.</li>
          <li><strong>Postparto:</strong> Propilenglicol para evitar cetosis.</li>
          <li><strong>Producci√≥n:</strong> Grasas protegidas y prote√≠nas balanceadas.</li>
        </ul>
      </div>
    </div>
    
    <!-- Sanitario -->
    <div class="card shadow-sm border-left-accent mb-4">
      <div class="card-body">
        <h5 class="section-title">üöë Manejo sanitario</h5>
        <ul>
          <li><strong>Vacunas:</strong> Aftosa, brucelosis, clostridiosis, IBR, BVD, leptospira.</li>
          <li><strong>Antiparasitarios:</strong> Internos (albendazol, ivermectina) y externos (amitraz, cipermetrina).</li>
          <li><strong>Cuidados especiales:</strong> Control de cojeras y problemas articulares por su tama√±o.</li>
        </ul>
      </div>
    </div>
    
    <!-- Reproducci√≥n -->
    <div class="card shadow-sm border-left-accent mb-4">
      <div class="card-body">
        <h5 class="section-title">üë∂ Reproducci√≥n</h5>
        <ul>
          <li><strong>Primer parto:</strong> 24‚Äì30 meses.</li>
          <li><strong>Intervalo entre partos:</strong> 13‚Äì14 meses.</li>
          <li><strong>Partos:</strong> Tienden a ser m√°s complicados por el tama√±o del ternero.</li>
          <li><strong>Ventajas:</strong> Buen instinto maternal y producci√≥n de calostro.</li>
        </ul>
      </div>
    </div>
    
    <!-- Ventajas y desventajas -->
    <div class="card shadow-sm border-left-accent mb-5">
      <div class="card-body">
        <h5 class="section-title">üìä Ventajas y desventajas</h5>
        <div class="row">
          <div class="col-md-6">
            <p class="fw-bold">Ventajas üåü</p>
            <ul>
              <li>Excelente raza de doble prop√≥sito.</li>
              <li>Carne de alta calidad y buena producci√≥n de leche.</li>
              <li>R√∫stica y adaptable.</li>
            </ul>
          </div>
          <div class="col-md-6">
            <p class="fw-bold">Desventajas ‚ö†Ô∏è</p>
            <ul>
              <li>Requiere mayor cantidad de alimento.</li>
              <li>Partos m√°s dif√≠ciles por cr√≠as grandes.</li>
              <li>Menor eficiencia alimenticia comparada con Jersey.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    
    <h2 class="mb-4 text-center page-title">üêÑ Mis Vacas Simmental</h2>
<!-- üü¶ Selector de Lote Mejorado -->
    <div class="selector-lote-container">
      <div class="selector-lote-card">
        <div class="selector-icono">üêÑ</div>
        <label class="selector-label">Selecciona un lote</label>
        <select id="selectorLote" class="selector-lote-custom">
          <option value="">-- Selecciona un lote --</option>
        </select>
        <div class="selector-decoracion"></div>
      </div>
    </div>

        <input 
      type="text" 
      id="buscarVaca"
      class="form-control mb-4"
      placeholder="üîç Buscar vaca por nombre, ID, padre, madre..."
      style="display:none;"
    >

    <div id="tabla-simmental" ></div>
  </main>

<!-- MODAL QR CODE -->
<div class="modal fade" id="modalQR" tabindex="-1" aria-labelledby="modalQRLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-qr">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100 text-center" id="modalQRLabel">
          üì± Descarga la App BoviGestf
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-4">
        <p class="mb-4">Escanea el c√≥digo QR con tu dispositivo m√≥vil</p>
        
        <!-- üëá AQU√ç VA TU C√ìDIGO QR -->
        <div class="qr-container">
          <img src="img/qr-code-app.png" alt="QR Code" class="qr-image">
          <!-- Si no tienes imagen, puedes usar un servicio de generaci√≥n -->
          <!-- <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=TU_ENLACE_APK" alt="QR Code" class="qr-image"> -->
        </div>

        <div class="download-info mt-4">
          <div class="info-badge">
            <span class="badge-icon">ü§ñ</span>
            <span class="badge-text">Android APK</span>
          </div>
          <p class="text-muted small mt-3 mb-0">
            O descarga directamente desde tu m√≥vil:
          </p>
          <a href="TU_ENLACE_DIRECTO_APK" class="btn btn-download-direct mt-2" download>
            <span>‚¨áÔ∏è</span> Descargar APK
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

  
<!-- Modal Editar -->
<div class="modal fade" id="editarModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header modal-header-verde">
        <h5 class="modal-title">Editar Vaca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="formEditar">

          <input type="hidden" id="edit-id">

          <div class="row g-3">

            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input id="edit-nombre" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">ID Interno</label>
              <input id="edit-internalId" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Peso (kg)</label>
              <input type="number" id="edit-peso" class="form-control" step="any">
            </div>

            <div class="col-md-4">
              <label class="form-label">Edad (a√±os)</label>
              <input type="number" id="edit-edad" class="form-control">
            </div>

            <div class="col-md-4">
              <label class="form-label">Producci√≥n (L/d√≠a)</label>
              <input type="number" id="edit-leche" class="form-control" step="any">
            </div>

            <div class="col-md-6">
              <label class="form-label">Lactando</label>
              <select id="edit-lactando" class="form-select">
                <option value="true">S√≠</option>
                <option value="false">No</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">G√©nero</label>
              <select id="edit-genero" class="form-select">
                <option value="">-- Selecciona --</option>
                <option value="Hembra">Hembra</option>
                <option value="Macho">Macho</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Fecha de nacimiento</label>
              <input type="date" id="edit-nacimiento" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Estado reproductivo</label>
              <select id="edit-reproductivo" class="form-select">
                <option value="">-- Selecciona --</option>
                <option>Seca</option>
                <option>Lactando</option>
                <option>Gestante</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Padre</label>
              <input id="edit-padre" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Madre</label>
              <input id="edit-madre" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Prop√≥sito</label>
              <select id="edit-proposito" class="form-select">
                <option value="">-- Selecciona --</option>
                <option>Leche</option>
                <option>Carne</option>
                <option>Reproducci√≥n</option>
                <option>Mixto</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Origen</label>
              <input id="edit-origen" class="form-control">
            </div>

            <div class="col-md-6">
              <label class="form-label">Chip ID</label>
              <input id="edit-chip" class="form-control">
            </div>

            <div class="col-12">
              <label class="form-label">Notas</label>
              <textarea id="edit-notas" class="form-control" rows="3"></textarea>
            </div>

          </div>

          <button class="btn btn-success w-100 mt-3">Guardar cambios</button>

        </form>
      </div>

    </div>
  </div>
</div>


<!-- Modal Eliminar -->
  <div class="modal fade" id="eliminarModal" tabindex="-1" aria-labelledby="eliminarLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header modal-header-verde text-white">
          <h5 class="modal-title" id="eliminarLabel">Eliminar Vaca</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>¬øSeguro que deseas eliminar la vaca <strong id="nombreEliminar"></strong>?</p>
          <input type="hidden" id="delete-id">
          <button id="btnConfirmEliminar" class="btn btn-verde w-100">S√≠, eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot√≥n flotante -->
  <button id="btn-flotante" onclick="scrollToTabla()">üêÑ Tus vacas registradas</button>

<!-- üü¢ Modal Selecci√≥n de Medicamento -->
  <div class="modal fade" id="modalMedicamentos" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">

        <div class="modal-header modal-header-verde-pastel">
          <h5 class="modal-title">Seleccionar Medicamento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <!-- üîç Buscador -->
          <input type="text" id="buscarMedicamento" class="form-control mb-3"
                placeholder="Buscar medicamento..." oninput="filtrarMedicamentos()">

          <!-- Tarjetas -->
          <div id="contenedorTarjetasMedicamentos" class="row g-3"></div>
          
        </div>

      </div>
    </div>
  </div>

  <!-- üü¢ Modal para completar registro -->
<div class="modal fade" id="modalRegistrarMed" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header modal-header-verde">
        <h5 class="modal-title">Registrar Medicamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p><strong>Medicamento seleccionado:</strong> <span id="medNombreSeleccionado"></span></p>

        <label>Dosis administrada (ml):</label>
        <input type="number" id="medDosis" class="form-control mb-3"
        placeholder="Ej: 30.5" step="0.01">


        <label>Observaciones:</label>
        <textarea id="medObservaciones" class="form-control mb-3" rows="3"></textarea>

        <button class="btn btn-verde w-100" onclick="guardarRegistroMedicamento()">Guardar registro</button>
      </div>

    </div>
  </div>
</div>

  <!-- üü° Modal Historial -->
<div class="modal fade" id="modalHistorial" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content shadow-lg">

      <div class="modal-header modal-header-verde">
        <h5 class="modal-title">üìú Historial de la vaca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

          <div class="col-md-6">
            <div class="historial-filtros d-flex flex-wrap gap-2 mb-3 justify-content-center">

              <button class="filtro-btn active" data-filtro="todo">Todos</button>
              <button class="filtro-btn" data-filtro="med">Medicamentos</button>
              <button class="filtro-btn" data-filtro="insumo">Insumos</button>
              <button class="filtro-btn" data-filtro="enf">Enfermedades</button>

            </div>

          </div>
        </div>

        <div id="historialContenido"></div>

      </div>

    </div>
  </div>
</div>


  <!-- üü¢ Modal Selecci√≥n de Insumo -->
<div class="modal fade" id="modalInsumos" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header modal-header-verde-pastel">
        <h5 class="modal-title">Seleccionar Insumo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- üîç Buscador -->
        <input type="text" id="buscarInsumo" class="form-control mb-3"
               placeholder="Buscar insumo..." oninput="filtrarInsumos()">

        <!-- Tarjetas -->
        <div id="contenedorTarjetasInsumos" class="row g-3"></div>

      </div>

    </div>
  </div>
</div>

<!-- üü¢ Modal Registrar Insumo -->
<div class="modal fade" id="modalRegistrarInsumo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header modal-header-verde">
        <h5 class="modal-title">Registrar Insumo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p><strong>Insumo seleccionado:</strong> <span id="insumoNombreSeleccionado"></span></p>

        <label>Cantidad suministrada(kg):</label>
        <input type="number" step="0.01" id="insumoCantidad"
               class="form-control mb-3" placeholder="Ej: 12.5">

        <label>Observaciones:</label>
        <textarea id="insumoObservaciones" class="form-control mb-3" rows="3"></textarea>

        <button class="btn btn-verde w-100" onclick="guardarRegistroInsumo()">Guardar registro</button>
      </div>

    </div>
  </div>
</div>

<!-- üü£ Modal Selecci√≥n de Enfermedades -->
<div class="modal fade" id="modalEnfermedades" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header modal-header-limon">
        <h5 class="modal-title">Seleccionar Enfermedad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="text" id="buscarEnfermedad" class="form-control mb-3"
               placeholder="Buscar enfermedad..." oninput="filtrarEnfermedades()">

        <div id="contenedorTarjetasEnfermedades" class="row g-3"></div>

      </div>

    </div>
  </div>
</div>

<!-- üü£ Modal Registrar Enfermedad -->
<div class="modal fade" id="modalRegistrarEnfermedad" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header modal-header-verde">
        <h5 class="modal-title">Registrar Enfermedad</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <p><strong>Enfermedad seleccionada:</strong> <span id="enfNombreSeleccionada"></span></p>

        <label>Fecha en la que surgi√≥:</label>
        <input type="date" id="enfFecha" class="form-control mb-3">

        <label>Notas / descripci√≥n:</label>
        <textarea id="enfObservaciones" class="form-control mb-3" rows="3"></textarea>

        <button class="btn btn-verde w-100" onclick="guardarRegistroEnfermedad()">
          Guardar enfermedad
        </button>

      </div>

    </div>
  </div>
</div>

<!-- üü¶ PANEL DE REGISTROS -->
<div class="modal fade" id="modalPanelRegistros" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header modal-header-verde">
        <h5 class="modal-title">Seleccionar tipo de registro</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body text-center">

        <button class="btn btn-verde-pastel w-100 mb-3"
          onclick="abrirModalRegistro(window.vacaSeleccionada,'medicamento')">
          üíä Medicamentos
        </button>

        <button class="btn btn-verde-pastel w-100 mb-3"
          onclick="abrirModalRegistro(window.vacaSeleccionada,'insumo')">
          üåæ Insumos
        </button>

        <button class="btn btn-verde-pastel w-100 mb-3"
          onclick="abrirModalRegistro(window.vacaSeleccionada,'enfermedad')">
          üü• Enfermedades
        </button>

        <button class="btn btn-verde-pastel w-100 "
          onclick="abrirModalRegistro(window.vacaSeleccionada,'graficas')">
          üìä Gr√°ficas
        </button>

        <button class="btn btn-success w-100 mt-3"
          onclick="generarReportePDF(window.vacaSeleccionada)">
          üìÑ Generar Reporte PDF
        </button>

      </div>

    </div>
  </div>
</div>

<div id="toast" class="toast align-items-center text-white bg-success border-0 position-fixed bottom-0 end-0 m-3" role="alert">
  <div class="d-flex">
    <div class="toast-body" id="toastMsg"></div>
    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
  </div>
</div>


<!-- Modales para editar -->

<div class="modal fade" id="modalEditarMedicamento" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">

      <div class="modal-header modal-header-verde-pastel" >
        <h5 class="modal-title">‚úèÔ∏è Editar Medicamento</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="hidden" id="editMedId">

        <label class="fw-bold">Nombre:</label>
        <input type="text" id="editMedNombre" class="form-control mb-3" disabled>

        <label class="fw-bold">Dosis administrada (ml)</label>
        <input type="number" id="editMedDosis" class="form-control mb-3">

        <label class="fw-bold">Notas</label>
        <textarea id="editMedNotas" class="form-control mb-3" rows="3"></textarea>

        <button class="btn btn-verde-pastel w-100" onclick="guardarEdicionMedicamento()">Guardar cambios</button>

      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalEditarInsumo" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">

      <div class="modal-header modal-header-verde-pastel">
        <h5 class="modal-title">‚úèÔ∏è Editar Insumo</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="hidden" id="editInsumoId">

        <label class="fw-bold">Nombre:</label>
        <input type="text" id="editInsumoNombre" class="form-control mb-3" disabled>

        <label class="fw-bold">Cantidad (kg):</label>
        <input type="number" id="editInsumoCantidad" class="form-control mb-3">

        <label class="fw-bold">Notas</label>
        <textarea id="editInsumoNotas" class="form-control mb-3" rows="3"></textarea>

        <button class="btn btn-verde-pastel w-100" onclick="guardarEdicionInsumo()">Guardar cambios</button>

      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="modalEditarEnfermedad" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content border-0 shadow">

      <div class="modal-header" style="background:#e86a6a; color:white;">
        <h5 class="modal-title">‚úèÔ∏è Editar Enfermedad</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <input type="hidden" id="editEnfId">

        <label class="fw-bold">Nombre:</label>
        <input type="text" id="editEnfNombre" class="form-control mb-3" disabled>

        <label class="fw-bold">Fecha en que surgi√≥:</label>
        <input type="date" id="editEnfFecha" class="form-control mb-3">

        <label class="fw-bold">Notas:</label>
        <textarea id="editEnfNotas" class="form-control mb-3" rows="3"></textarea>

        <button class="btn btn-verde-pastel w-100" onclick="guardarEdicionEnfermedad()">Guardar cambios</button>

      </div>

    </div>
  </div>
</div>

<!-- üü© MODAL DE GR√ÅFICAS -->
<div class="modal fade" id="modalGraficas" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header modal-header-verde">
        <h5 class="modal-title">üìä Estad√≠sticas de la Vaca</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- TABS PESO / LECHE -->
        <div class="d-flex justify-content-center mb-3">
          <button id="tabPeso" class="btn btn-success me-2">Peso</button>
          <button id="tabLeche" class="btn btn-success">Producci√≥n de leche</button>
        </div>

        <!-- GR√ÅFICA -->
        <div style="overflow-x:auto; overflow-y:hidden; width:100%; padding-bottom:8px; border-radius:8px; background:#f8f9fa;">
          <div id="canvasContainer" style="min-width:600px; padding:15px;">
            <canvas id="graficaVaca" style="display:block; height:350px;"></canvas>
          </div>
        </div>

        <hr>

        <!-- HISTORIAL -->
        <h5>üìú Historial</h5>
        <div id="historialGraficas"></div>

      </div>

    </div>
  </div>
</div>

  <!-- Firebase y Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, deleteDoc, updateDoc, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzonIFbhlOnnIs9xG9Lb4uBJHLrhCi3qU",
      authDomain: "web-y-movil-agroncontrol.firebaseapp.com",
      projectId: "web-y-movil-agroncontrol",
      storageBucket: "web-y-movil-agroncontrol.firebasestorage.app",
      messagingSenderId: "180502593551",
      appId: "1:180502593551:web:f4ae5111ac99ec70fa237a",
      measurementId: "G-BJ9G9WSKNY"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let usuarioId = null;
    let loteSeleccionado = "";

// üü¢ Crear tarjetas en lugar de tabla
function crearTarjetasVacas(vacas) {
  if (vacas.length === 0) return "<p class='text-center text-muted'>No hay vacas Simmental registradas.</p>";

  let html = '<div class="row g-4">';

  vacas.forEach(v => {
    const data = v.data;
    
    html += `
      <div class="col-md-6 col-lg-4">
        <div class="vaca-card" data-id="${v.id}">
          
          <!-- Encabezado con nombre y estado -->
          <div class="vaca-card-header">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="vaca-nombre mb-1">üêÑ ${data.name}</h5>
                ${data.internalId ? `<small class="id-interno">ID: ${data.internalId}</small>` : ''}
              </div>
              <span class="badge-lactando ${data.isLactating ? 'lactando' : 'seca'}">
                ${data.isLactating ? '‚úì Lactando' : '‚óã Seca'}
              </span>
            </div>
          </div>
          
          <!-- Info b√°sica siempre visible -->
          <div class="vaca-card-body">
            <div class="info-basica">
              <div class="info-item">
                <span class="info-icon">‚öñÔ∏è</span>
                <div>
                  <small class="text-muted d-block">Peso</small>
                  <strong class="info-valor">${data.weight} kg</strong>
                </div>
              </div>

              <div class="info-item">
                <span class="info-icon">üìÖ</span>
                <div>
                  <small class="text-muted d-block">Edad</small>
                  <strong class="info-valor">${data.age} a√±os</strong>
                </div>
              </div>

              <div class="info-item">
                <span class="info-icon">ü•õ</span>
                <div>
                  <small class="text-muted d-block">Producci√≥n</small>
                  <strong class="info-valor">${data.milkProduction ?? '-'} L/d√≠a</strong>
                </div>
              </div>
            </div>

            <!-- Detalles expandibles (ocultos por defecto) -->
            <div class="vaca-detalles" id="detalles-${v.id}" style="display: none;">
              
              <div class="detalles-grid">
                ${data.gender ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">‚ö•</span>
                    <div>
                      <small class="detalle-label">G√©nero</small>
                      <span class="detalle-valor">${data.gender}</span>
                    </div>
                  </div>
                ` : ''}

                ${data.birthDate ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">üéÇ</span>
                    <div>
                      <small class="detalle-label">Nacimiento</small>
                      <span class="detalle-valor">${new Date(data.birthDate).toLocaleDateString()}</span>
                    </div>
                  </div>
                ` : ''}

                ${data.fatherName ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">‚ôÇÔ∏è</span>
                    <div>
                      <small class="detalle-label">Padre</small>
                      <span class="detalle-valor">${data.fatherName}</span>
                    </div>
                  </div>
                ` : ''}

                ${data.motherName ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">‚ôÄÔ∏è</span>
                    <div>
                      <small class="detalle-label">Madre</small>
                      <span class="detalle-valor">${data.motherName}</span>
                    </div>
                  </div>
                ` : ''}


                ${data.gender === "Hembra" && data.reproductiveStatus ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">ü•õ</span>
                    <div>
                      <small class="detalle-label">Estado reproductivo</small>
                      <span class="detalle-valor">${data.reproductiveStatus}</span>
                    </div>
                  </div>
                ` : ''}


                ${data.purpose ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">üéØ</span>
                    <div>
                      <small class="detalle-label">Prop√≥sito</small>
                      <span class="detalle-valor">${data.purpose}</span>
                    </div>
                  </div>
                ` : ''}

                ${data.origin ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">üìç</span>
                    <div>
                      <small class="detalle-label">Origen</small>
                      <span class="detalle-valor">${data.origin}</span>
                    </div>
                  </div>
                ` : ''}

                ${data.chipId ? `
                  <div class="detalle-item">
                    <span class="detalle-icono">üí≥</span>
                    <div>
                      <small class="detalle-label">Chip ID</small>
                      <span class="detalle-valor">${data.chipId}</span>
                    </div>
                  </div>
                ` : ''}

                ${data.notes ? `
                  <div class="detalle-item detalle-full">
                    <span class="detalle-icono">üìù</span>
                    <div>
                      <small class="detalle-label">Notas</small>
                      <span class="detalle-valor">${data.notes}</span>
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>

            <!-- Bot√≥n compacto para expandir -->
            <button class="btn-expandir-compacto" onclick="toggleDetalles('${v.id}')">
              <span class="expandir-texto">M√°s informaci√≥n</span>
              <span class="expandir-icono">‚Ä∫</span>
            </button>

            <!-- Acciones -->
            <div class="vaca-acciones">
              <button class="btn-accion 
              btn-verde-pastel" data-bs-toggle="modal" 
              onclick="cargarDatosEditar('${v.id}')">
                <span class="btn-texto">Editar</span>
              </button>

              <button class="btn-accion btn-verde-pastel"
                      onclick="abrirPanelRegistros('${v.id}')">
                
                <span class="btn-texto">Registros</span>
              </button>

              <button class="btn-accion btn-verde-pastel"
                      onclick="verHistorial('${v.id}')">
                
                <span class="btn-texto">Historial</span>
              </button>

              <button class="btn-accion btn-verde-pastel"
                      data-bs-toggle="modal" 
                      data-bs-target="#eliminarModal"
                      onclick="prepararEliminar('${v.id}','${data.name}')">
                
                <span class="btn-texto">Eliminar</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });

  html += '</div>';
  return html;
}

// Funci√≥n para expandir/contraer detalles
window.toggleDetalles = function(vacaId) {
  const detalles = document.getElementById(`detalles-${vacaId}`);
  const boton = event.target.closest('.btn-expandir-compacto');
  const texto = boton.querySelector('.expandir-texto');
  const icono = boton.querySelector('.expandir-icono');
  
  if (detalles.style.display === 'none') {
    detalles.style.display = 'block';
    texto.textContent = 'Menos informaci√≥n';
    icono.textContent = '‚Äπ';
    icono.style.transform = 'rotate(-90deg)';
    boton.classList.add('expandido');
  } else {
    detalles.style.display = 'none';
    texto.textContent = 'M√°s informaci√≥n';
    icono.textContent = '‚Ä∫';
    icono.style.transform = 'rotate(90deg)';
    boton.classList.remove('expandido');
  }
};
        // üü¢ Cargar vacas Simmental
    async function cargarVacas(userId, loteId = null) {
  let filtros = [
    where("breed", "==", "Simmental")
  ];

  if (loteId) {
    filtros.push(where("lotId", "==", loteId));
  }

  const q = query(collection(db, "users", userId, "cows"), ...filtros);
  const querySnap = await getDocs(q);

  const vacas = querySnap.docs.map(docSnap => ({
    id: docSnap.id,
    data: docSnap.data()
  }));

  document.getElementById("tabla-simmental").innerHTML = crearTarjetasVacas(vacas);
}

// üü¢ Pasar datos al modal de edici√≥n

// Funci√≥n principal que se llama desde el bot√≥n "Editar" de la tarjeta de la vaca
window.cargarDatosEditar = async function(vacaId) {
    // 1. Guardar la ID de la vaca seleccionada (√∫til para la funci√≥n 'guardar cambios')
    window.vacaSeleccionada = vacaId;
    document.getElementById("edit-id").value = vacaId;

    // 2. Referencia y obtenci√≥n del documento de Firebase
    const vacaRef = doc(db, "users", usuarioId, "cows", vacaId);
    const docSnap = await getDoc(vacaRef);

    if (docSnap.exists()) {
        const data = docSnap.data();
        
        // 3. Llenar el formulario con los datos obtenidos
        llenarFormulario(data);
        
        // 4. Abrir el modal de edici√≥n
        const editModal = new bootstrap.Modal(document.getElementById('editarModal'));
        editModal.show();
        
    } else {
        console.error("No se encontr√≥ el documento de la vaca con ID:", vacaId);
        // Funci√≥n para mostrar mensajes al usuario (asumo que tienes 'mostrarToast')
        mostrarToast("Error: No se encontraron los datos de la vaca.", "danger");
    }
}

// Funci√≥n auxiliar para asignar los datos a los campos del modal
function llenarFormulario(data) {
    
    // Campos de texto e inputs
    document.getElementById("edit-nombre").value = data.name || "";
    document.getElementById("edit-peso").value = data.weight || "";
    document.getElementById("edit-chip").value = data.chipId || "";
    document.getElementById("edit-origen").value = data.origin || "";
    document.getElementById("edit-padre").value = data.fatherName || "";
    document.getElementById("edit-madre").value = data.motherName || "";
    document.getElementById("edit-notas").value = data.notes || "";
    document.getElementById("edit-internalId").value = data.internalId || "";
    document.getElementById("edit-edad").value = data.age || "";
    document.getElementById("edit-leche").value = data.milkProduction || "";

    // Campo de fecha: Es crucial formatear la fecha a YYYY-MM-DD para que el input type="date" lo reconozca.
    // Asumo que 'birthDate' est√° guardado como un string ISO (ej: 2025-01-01T00:00:00.000Z)
    document.getElementById("edit-nacimiento").value = data.birthDate ? data.birthDate.split("T")[0] : "";
    
    // Selects (para estado reproductivo, g√©nero y prop√≥sito)
    document.getElementById("edit-genero").value = data.gender || "";
    document.getElementById("edit-reproductivo").value = data.reproductiveStatus || ""; 
    document.getElementById("edit-proposito").value = data.purpose || "";               

    // Checkbox (Para si est√° lactando o no)
    // Se debe asignar un valor booleano (true/false) a la propiedad 'checked'.
    document.getElementById("edit-lactando").value = data.isLactating ? "true" : "false";

}


    // üü¢ Guardar cambios
    document.getElementById("formEditar").addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = document.getElementById("edit-id").value;
      const nombre = document.getElementById("edit-nombre").value;
      const peso = parseFloat(document.getElementById("edit-peso").value);
      const edad = parseInt(document.getElementById("edit-edad").value);
      const leche = parseFloat(document.getElementById("edit-leche").value);
      const lactando = document.getElementById("edit-lactando").value === "true";
      await updateDoc(doc(db, "users", usuarioId, "cows", id), {
        name: document.getElementById("edit-nombre").value,
        internalId: document.getElementById("edit-internalId").value,
        weight: parseFloat(document.getElementById("edit-peso").value),
        age: parseInt(document.getElementById("edit-edad").value),
        milkProduction: parseFloat(document.getElementById("edit-leche").value),
        isLactating: document.getElementById("edit-lactando").value === "true",
        gender: document.getElementById("edit-genero").value,
        birthDate: document.getElementById("edit-nacimiento").value || null,
        fatherName: document.getElementById("edit-padre").value,
        motherName: document.getElementById("edit-madre").value,
        reproductiveStatus: document.getElementById("edit-reproductivo").value,
        purpose: document.getElementById("edit-proposito").value,
        origin: document.getElementById("edit-origen").value,
        chipId: document.getElementById("edit-chip").value,
        notes: document.getElementById("edit-notas").value
    });

      bootstrap.Modal.getInstance(document.getElementById("editarModal")).hide();
      cargarVacas(usuarioId, loteSeleccionado);
    });

    // Funci√≥n para limpiar el formulario de edici√≥n
function limpiarFormulario() {
    document.getElementById("edit-id").value = "";
    document.getElementById("edit-nombre").value = "";
    document.getElementById("edit-internalId").value = "";
    document.getElementById("edit-peso").value = "";
    document.getElementById("edit-edad").value = "";
    document.getElementById("edit-leche").value = "";
    document.getElementById("edit-chip").value = "";
    document.getElementById("edit-origen").value = "";
    document.getElementById("edit-padre").value = "";
    document.getElementById("edit-madre").value = "";
    document.getElementById("edit-notas").value = "";
    document.getElementById("edit-nacimiento").value = "";

    document.getElementById("edit-genero").value = "";
    document.getElementById("edit-reproductivo").value = ""; 
    document.getElementById("edit-proposito").value = "";               

     document.getElementById("edit-lactando").value = "";


}

document.getElementById("editarModal").addEventListener("hidden.bs.modal", () => {
    limpiarFormulario();
});



    // üü¢ Eliminar vaca
    window.prepararEliminar = function(id, nombre) {
      document.getElementById("delete-id").value = id;
      document.getElementById("nombreEliminar").innerText = nombre;
    };

    document.getElementById("btnConfirmEliminar").addEventListener("click", async () => {
      const id = document.getElementById("delete-id").value;
      await deleteDoc(doc(db, "users", usuarioId, "cows", id));
      bootstrap.Modal.getInstance(document.getElementById("eliminarModal")).hide();
      cargarVacas(usuarioId, loteSeleccionado);
    });
    
    // üü¢ Detectar sesi√≥n
    onAuthStateChanged(auth, (user) => {
  if (user) {
    usuarioId = user.uid;
    cargarLotesUsuario(); // solo carga lotes
    document.getElementById("tabla-simmental").innerHTML = `
      <p class='text-center text-muted'>Selecciona un lote</p>
    `;
  } else {
    document.getElementById("tabla-simmental").innerHTML =
      "<p class='text-danger text-center'>Debes iniciar sesi√≥n para ver tus vacas.</p>";
  }
});


//Lotes
async function cargarLotesUsuario() {
  const lotesRef = collection(db, "users", usuarioId, "lots");
  const snap = await getDocs(lotesRef);

  const selector = document.getElementById("selectorLote");

  snap.forEach(docu => {
    const lote = docu.data();

    selector.innerHTML += `
      <option value="${docu.id}">${lote.name}</option>
    `;
  });
}

//SE LE APLICA A LAS OTRAS VACAS
document.getElementById("selectorLote").addEventListener("change", function () {
  loteSeleccionado = this.value; // üü¢ Guardar lote seleccionado

  if (loteSeleccionado === "") {
    document.getElementById("tabla-simmental").innerHTML =
      "<p class='text-center text-muted'>Selecciona un lote</p>";
  } else {
    cargarVacas(usuarioId, loteSeleccionado); // üü¢ Filtrar por lote
  }
});

//filtro para buscar vacas
    document.getElementById("buscarVaca").addEventListener("input", () => {
  const texto = document.getElementById("buscarVaca").value.toLowerCase();

  document.querySelectorAll(".vaca-card").forEach(card => {
    const contenido = card.innerText.toLowerCase();
    card.style.display = contenido.includes(texto) ? "" : "none";
  });
});
//Mostrar barra cuando solo el lote este seleccionado
document.getElementById("selectorLote").addEventListener("change", function () {
  loteSeleccionado = this.value;

  if (loteSeleccionado === "") {
    document.getElementById("buscarVaca").style.display = "none";
    document.getElementById("tabla-simmental").innerHTML =
      "<p class='text-center text-muted'>Selecciona un lote</p>";
  } else {
    document.getElementById("buscarVaca").style.display = "block";
    cargarVacas(usuarioId, loteSeleccionado);
  }
});



   //Medicamento

async function cargarTarjetasMedicamentosEstaticas() {
  try {
    const resp = await fetch("Medicamentos.html");

    if (!resp.ok) {
      console.error("No se encontr√≥ Medicamentos.html");
      return;
    }

    const htmlTexto = await resp.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlTexto, "text/html");

    const tarjetas = doc.querySelectorAll(".med-card");

    let html = "";

    tarjetas.forEach(card => {
      const nombre = card.querySelector(".med-card-title")?.textContent.trim() || "Medicamento";

      let imagen = card.querySelector(".med-card-img")?.getAttribute("src") || "";
      imagen = imagen.startsWith("http") ? imagen : "img/" + imagen.replace("img/", "");

      const categoria = card.querySelector(".med-card-category")?.textContent || "";
      const desc = card.querySelector(".med-card-desc")?.textContent || "";

      html += `
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <img src="${imagen}" class="card-img-top" style="height:160px; object-fit:cover;">
            <div class="card-body">
              <span class="badge bg-success mb-1">${categoria}</span>
              <h5 class="card-title">${nombre}</h5>
              <p class="card-text small">${desc}</p>
              <button class="btn btn-verde-pastel w-100 text-white"
                onclick="seleccionarMedicamento('${nombre}')">
                Seleccionar
              </button>
            </div>
          </div>
        </div>
      `;
    });

    document.getElementById("contenedorTarjetasMedicamentos").innerHTML = html;

  } catch (error) {
    console.error("Error cargando Medicamentos.html:", error);
  }
}

//Registro

 window.cerradoPorGuardar = false;

window.guardarRegistroMedicamento = async function () {

  window.cerradoPorGuardar = true; // üü¢ Para evitar abrir el otro modal

  const vacaId = window.vacaSeleccionada;
  const dosis = parseFloat(document.getElementById("medDosis").value) || 0;
  const obs = document.getElementById("medObservaciones").value || "";

  await addDoc(collection(db, "users", usuarioId, "cows", vacaId, "applied_medications"), {
    name: window.medicamentoSeleccionado,
    dose_administered_ml: dosis,
    observations: obs,
    date: new Date().toISOString()
  });

 mostrarToast("Medicamento registrado correctamente");

  // LIMPIAR CAMPOS üòÅ
  document.getElementById("medDosis").value = "";
  document.getElementById("medObservaciones").value = "";

  bootstrap.Modal.getInstance(document.getElementById("modalRegistrarMed")).hide();
  bootstrap.Modal.getInstance(document.getElementById("modalMedicamentos")).hide();
};


// MODALES DEL REGISTRO 
window.abrirModalRegistro = async function (vacaId, tipo) {
  window.vacaSeleccionada = vacaId;

   // üõë Cerrar panel antes de abrir otro modal
  const panel = bootstrap.Modal.getInstance(
    document.getElementById("modalPanelRegistros")
  );
  if (panel) panel.hide();


  // ==========================
  // üåæ INSUMOS
  // ==========================
  if (tipo === "insumo") {
    await cargarTarjetasInsumosEstaticos();
    bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalInsumos")
    ).show();
  }

  // ==========================
  // üíä MEDICAMENTOS
  // ==========================
  if (tipo === "medicamento") {
    await cargarTarjetasMedicamentosEstaticas();
    bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalMedicamentos")
    ).show();
  }

  // ==========================
  // üü• ENFERMEDADES
  // ==========================
  if (tipo === "enfermedad") {
    await cargarTarjetasEnfermedadesEstaticas();  
    bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalEnfermedades")
    ).show();
  }

  // ==========================
  // üìä GR√ÅFICAS (PESO / LECHE)
  // ==========================
if (tipo === "graficas") {
    await cargarGraficasDeLaVaca(vacaId);
    bootstrap.Modal.getOrCreateInstance(
      document.getElementById("modalGraficas")
    ).show();
}

};

window.filtrarMedicamentos = function () {
  const texto = document.getElementById("buscarMedicamento").value.toLowerCase();

  document.querySelectorAll("#contenedorTarjetasMedicamentos .card").forEach(card => {
    const titulo = card.querySelector(".card-title").innerText.toLowerCase();
    card.parentElement.style.display = titulo.includes(texto) ? "" : "none";
  });
};

// funcion para llenar el modal del historial 

window.verHistorial = async function (vacaId) {

  let html = "";

  // ===============================
  // üíä MEDICAMENTOS
  // ===============================
  const medsSnap = await getDocs(
    collection(db, "users", usuarioId, "cows", vacaId, "applied_medications")
  );

  html += `<div class="titulo-seccion-historial">Medicamentos aplicados</div>`;

  if (medsSnap.empty) {
    html += `<p class="text-muted">No hay medicamentos registrados.</p>`;
  } else {
    medsSnap.forEach(docu => {
      const m = docu.data();

      html += `
  <div class="hist-item card mb-3 p-3 border-left-success" data-type="med">
    <h5 class="text-success"><b>üíä ${m.name}</b></h5>
    <small><b>Fecha:</b> ${new Date(m.date).toLocaleString()}</small>
    <small><b>Dosis:</b> ${m.dose_administered_ml} ml</small>
    <small><b>Notas:</b> ${m.observations || "Sin observaciones"}</small>

    <div class="mt-2 d-flex gap-2">
      <button class="btn btn-warning btn-sm"
        onclick="editarMedicamento('${docu.id}', '${vacaId}')">
        Editar
      </button>

      <button class="btn btn-verde btn-sm"
        onclick="eliminarRegistroMedicamento('${docu.id}', '${vacaId}')">
        Eliminar
      </button>
    </div>
  </div>
`;
    });
  }

  // ===============================
  // üåæ INSUMOS
  // ===============================
  const feedsSnap = await getDocs(
    collection(db, "users", usuarioId, "cows", vacaId, "applied_feeds")
  );

  html += `<div class="titulo-seccion-historial">Insumos aplicados</div>`;

  if (feedsSnap.empty) {
    html += `<p class="text-muted">No hay insumos registrados.</p>`;
  } else {
    feedsSnap.forEach(docu => {
      const d = docu.data();

      html += `
        <div class="hist-item card mb-3 p-3 border-left-green" data-type="insumo">
          <h5 class="text-success"><b>üåæ ${d.feedName}</b></h5>
          <small><b>Descripci√≥n:</b> ${d.description}</small>
          <small><b>Cantidad:</b> ${d.amountGiven}</small>
          <small><b>Fecha:</b> ${new Date(d.date).toLocaleString()}</small>
          <small><b>Notas:</b> ${d.observations || "Sin observaciones"}</small>

          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-warning btn-sm"
              onclick="editarInsumo('${docu.id}', '${vacaId}')">
              Editar
            </button>

            <button class="btn btn-verde btn-sm"
              onclick="eliminarRegistroInsumo('${docu.id}', '${vacaId}')">
              Eliminar
            </button>
          </div>
        </div>
      `;
    });
  }

  // ===============================
  // üü• ENFERMEDADES
  // ===============================
  const disSnap = await getDocs(
    collection(db, "users", usuarioId, "cows", vacaId, "diseases_history")
  );

  html += `<div class="titulo-seccion-historial">Enfermedades registradas</div>`;

  if (disSnap.empty) {
    html += `<p class="text-muted">No hay enfermedades registradas.</p>`;
  } else {
    disSnap.forEach(docu => {
      const d = docu.data();

      html += `
  <div class="hist-item card mb-3 p-3 border-left-danger" data-type="enf">
    <h5 class="text-danger"><b>üü• ${d.name}</b></h5>
    <small><b>Gravedad:</b> ${d.severity}</small>
    <small><b>Fecha inicio:</b> ${new Date(d.date).toLocaleDateString()}</small>
    <small><b>Registrado el:</b> ${new Date(d.registeredAt).toLocaleString()}</small>
    <small><b>Notas:</b> ${d.notes || "Sin observaciones"}</small>

    <div class="mt-2 d-flex gap-2">
      <button class="btn btn-warning btn-sm"
        onclick="editarEnfermedad('${docu.id}', '${vacaId}')">
        Editar
      </button>

      <button class="btn btn-verde btn-sm"
        onclick="eliminarRegistroEnfermedad('${docu.id}', '${vacaId}')">
        Eliminar
      </button>
    </div>
  </div>
`;
    });
  }

  // Mostrar resultado
  document.getElementById("historialContenido").innerHTML = html;

  document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());

  const modalElement = document.getElementById("modalHistorial");
  const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
  modal.show();
};

// üî• Activar botones cuando se abra el modal de historial
document.getElementById("modalHistorial").addEventListener("shown.bs.modal", () => {

  document.querySelectorAll(".filtro-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      const filtro = btn.getAttribute("data-filtro");

      // activar visualmente el bot√≥n
      document.querySelectorAll(".filtro-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      // aplicar filtro
      document.querySelectorAll("#historialContenido .hist-item").forEach(card => {
        const tipo = card.getAttribute("data-type");
        card.style.display = (filtro === "todo" || tipo === filtro) ? "" : "none";
      });

    });
  });

});


  window.seleccionarMedicamento = function(nombre) {

    window.medicamentoSeleccionado = nombre;
    document.getElementById("medNombreSeleccionado").innerText = nombre;

     // Limpiar inputs
    document.getElementById("medDosis").value = "";
    document.getElementById("medObservaciones").value = "";

    // Ocultar temporalmente el modal de selecci√≥n
    const modalSel = bootstrap.Modal.getInstance(document.getElementById("modalMedicamentos"));
    modalSel.hide();

    // Abrir modal de registro
    const modalReg = new bootstrap.Modal(document.getElementById("modalRegistrarMed"));
    modalReg.show();

    // Guardar referencia para reabrir si se cancela
    window.modalSeleccionMedicamento = modalSel;
  };

    document.getElementById("modalRegistrarMed").addEventListener("hidden.bs.modal", function () {

    if (!window.cerradoPorGuardar && window.modalSeleccionMedicamento) {
      window.modalSeleccionMedicamento.show();
    }

    // Reset siempre
    window.cerradoPorGuardar = false;
  });

  window.eliminarRegistroMedicamento = async function(id, vacaId) {
  await deleteDoc(doc(db, "users", usuarioId, "cows", vacaId, "applied_medications", id));
  verHistorial(vacaId); // recargar historial
};

//Insumos

async function cargarTarjetasInsumosEstaticos() {
  try {
    const resp = await fetch("insumos.html"); 

    if (!resp.ok) {
      console.error("No se encontr√≥ insumos.html");
      return;
    }

    const htmlTexto = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlTexto, "text/html");

    const tarjetas = doc.querySelectorAll(".insumo-card");

    let html = "";

    tarjetas.forEach(card => {
      const nombre = card.querySelector(".card-title")?.textContent.trim() || "Insumo";
      const descripcion = card.querySelector(".card-text")?.textContent.trim() || "";
      let imagen = card.querySelector(".card-img-top")?.getAttribute("src") || "";

      imagen = imagen.startsWith("http") ? imagen : "img/" + imagen.replace("img/", "");

      html += `
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <img src="${imagen}" class="card-img-top" style="height:160px; object-fit:cover;">
            <div class="card-body">
              <h5 class="card-title">${nombre}</h5>
              <p class="card-text small">${descripcion}</p>

              <button class="btn btn-verde-pastel w-100 text-white"
                onclick="seleccionarInsumo('${nombre}', \`${descripcion}\`)">
                Seleccionar
              </button>
            </div>
          </div>
        </div>
      `;
    });

    document.getElementById("contenedorTarjetasInsumos").innerHTML = html;

  } catch (error) {
    console.error("Error cargando insumos.html:", error);
  }
}

window.seleccionarInsumo = function(nombre, descripcion) {

  window.insumoSeleccionado = nombre;
  window.insumoDescripcion = descripcion;

  document.getElementById("insumoNombreSeleccionado").innerText = nombre;

  const modalSel = bootstrap.Modal.getInstance(document.getElementById("modalInsumos"));
  modalSel.hide();

  bootstrap.Modal.getOrCreateInstance(document.getElementById("modalRegistrarInsumo")).show();

  window.modalSeleccionInsumo = modalSel;
};

document.getElementById("modalRegistrarInsumo").addEventListener("hidden.bs.modal", function () {
  if (window.modalSeleccionInsumo && !window.cerradoPorGuardar) {
    window.modalSeleccionInsumo.show();
  }
  window.cerradoPorGuardar = false;
});


window.guardarRegistroInsumo = async function () {

  window.cerradoPorGuardar = true;

  const vacaId = window.vacaSeleccionada;
  const cantidad = parseFloat(document.getElementById("insumoCantidad").value) || 0;
  const obs = document.getElementById("insumoObservaciones").value || "";

  await addDoc(collection(db, "users", usuarioId, "cows", vacaId, "applied_feeds"), {
    feedName: window.insumoSeleccionado,
    description: window.insumoDescripcion,
    amountGiven: cantidad,
    observations: obs,
    date: new Date().toISOString()
  });

  mostrarToast("Insumo registrado correctamente");

  document.getElementById("insumoCantidad").value = "";
  document.getElementById("insumoObservaciones").value = "";

  bootstrap.Modal.getInstance(document.getElementById("modalRegistrarInsumo")).hide();
  bootstrap.Modal.getInstance(document.getElementById("modalInsumos")).hide();
};

window.filtrarInsumos = function () {
  const texto = document.getElementById("buscarInsumo").value.toLowerCase();

  document.querySelectorAll("#contenedorTarjetasInsumos .card").forEach(card => {
    const titulo = card.querySelector(".card-title").innerText.toLowerCase();
    card.parentElement.style.display = titulo.includes(texto) ? "" : "none";
  });
};

window.eliminarRegistroInsumo = async function(id, vacaId) {
  await deleteDoc(doc(db, "users", usuarioId, "cows", vacaId, "applied_feeds", id));
  verHistorial(vacaId);
};

// Enfermedades 
async function cargarTarjetasEnfermedadesEstaticas() {
  try {
    const resp = await fetch("enfermedades.html");

    if (!resp.ok) {
      console.error("No se encontr√≥ enfermedades.html");
      return;
    }

    const htmlTexto = await resp.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlTexto, "text/html");

    const tarjetas = doc.querySelectorAll(".enfermedad-card");

    let html = "";

    tarjetas.forEach(card => {
      const nombre = card.querySelector(".card-title-custom")?.textContent.trim() || "Sin nombre";
      const subtitulo = card.querySelector(".card-subtitle")?.textContent.trim() || "";
      const gravedad = card.querySelector(".severity-badge")?.textContent.trim() || "";
      const image = card.querySelector(".card-image")?.getAttribute("src") || "";

      html += `
        <div class="col-md-6">
          <div class="card shadow-sm h-100">

            <img src="${image}" class="card-img-top" style="height:200px; object-fit:cover;">

            <div class="card-body">
              <span class="badge bg-success mb-1">${gravedad}</span>

              <h5 class="card-title">${nombre}</h5>
              <p class="small">${subtitulo}</p>

              <button class="btn btn-verde-pastel w-100"
                onclick='seleccionarEnfermedad(${JSON.stringify({
                  name: nombre,
                  severity: gravedad,
                  image: image
                })})'>
                Seleccionar
              </button>

            </div>
          </div>
        </div>
      `;
    });

    document.getElementById("contenedorTarjetasEnfermedades").innerHTML = html;

  } catch (error) {
    console.error("Error cargando enfermedades:", error);
  }
}

window.seleccionarEnfermedad = function(data) {

  window.enfermedadSeleccionada = data;

  document.getElementById("enfNombreSeleccionada").innerText = data.name;

  const modalSel = bootstrap.Modal.getInstance(document.getElementById("modalEnfermedades"));
  modalSel.hide();

  bootstrap.Modal.getOrCreateInstance(document.getElementById("modalRegistrarEnfermedad")).show();

  window.modalSeleccionEnfermedad = modalSel;
};

document.getElementById("modalRegistrarEnfermedad").addEventListener("hidden.bs.modal", function () {
  if (window.modalSeleccionEnfermedad && !window.cerradoPorGuardar) {
    window.modalSeleccionEnfermedad.show();
  }
  window.cerradoPorGuardar = false;
});


window.guardarRegistroEnfermedad = async function () {

  window.cerradoPorGuardar = true;

  const vacaId = window.vacaSeleccionada;
  const fecha = document.getElementById("enfFecha").value;
  const notas = document.getElementById("enfObservaciones").value || "";

  if (!fecha) {
    alert("Debes seleccionar la fecha en la que surgi√≥ la enfermedad.");
    return;
  }

  await addDoc(
    collection(db, "users", usuarioId, "cows", vacaId, "diseases_history"),
    {
      ...window.enfermedadSeleccionada,
      notes: notas,
      date: new Date(fecha).toISOString(),
      registeredAt: new Date().toISOString()
    }
  );

  mostrarToast("Enfermedad registrado correctamente");

  document.getElementById("enfFecha").value = "";
  document.getElementById("enfObservaciones").value = "";

  bootstrap.Modal.getInstance(document.getElementById("modalRegistrarEnfermedad")).hide();
  bootstrap.Modal.getInstance(document.getElementById("modalEnfermedades")).hide();
};

window.filtrarEnfermedades = function () {
  const texto = document.getElementById("buscarEnfermedad").value.toLowerCase();

  document.querySelectorAll("#contenedorTarjetasEnfermedades .card").forEach(card => {
    const titulo = card.querySelector(".card-title").innerText.toLowerCase();
    card.parentElement.style.display = titulo.includes(texto) ? "" : "none";
  });
};

window.eliminarRegistroEnfermedad = async function (id, vacaId) {
  await deleteDoc(
    doc(db, "users", usuarioId, "cows", vacaId, "diseases_history", id)
  );
  verHistorial(vacaId);
};

window.abrirPanelRegistros = function(vacaId) {
  window.vacaSeleccionada = vacaId;

  const modal = new bootstrap.Modal(
    document.getElementById("modalPanelRegistros")
  );
  modal.show();
};

//Alertas

window.mostrarToast = function (mensaje, tipo = "success") {
  const toastEl = document.getElementById("toast");
  const toastMsg = document.getElementById("toastMsg");

  toastMsg.textContent = mensaje;

  toastEl.classList.remove("bg-success", "bg-danger", "bg-warning");
  toastEl.classList.add(
    tipo === "success" ? "bg-success" :
    tipo === "danger" ? "bg-danger" :
    "bg-warning"
  );

  const bsToast = new bootstrap.Toast(toastEl);
  bsToast.show();
};

//Modales para editar 

window.editarMedicamento = async function(id, vacaId) {

  window.vacaSeleccionada = vacaId;

  const ref = doc(db, "users", usuarioId, "cows", vacaId, "applied_medications", id);
  const snap = await getDoc(ref);

  const d = snap.data();

  document.getElementById("editMedId").value = id;
  document.getElementById("editMedNombre").value = d.name;
  document.getElementById("editMedDosis").value = d.dose_administered_ml;
  document.getElementById("editMedNotas").value = d.observations;

  new bootstrap.Modal(document.getElementById("modalEditarMedicamento")).show();
};

window.guardarEdicionMedicamento = async function () {

  const id = document.getElementById("editMedId").value;

  await updateDoc(doc(db, "users", usuarioId, "cows", window.vacaSeleccionada, "applied_medications", id), {
    dose_administered_ml: parseFloat(document.getElementById("editMedDosis").value),
    observations: document.getElementById("editMedNotas").value
  });

  mostrarToast("Medicamento actualizado");

  bootstrap.Modal.getInstance(document.getElementById("modalEditarMedicamento")).hide();
  verHistorial(window.vacaSeleccionada);
};

window.editarInsumo = async function(id, vacaId) {
  window.vacaSeleccionada = vacaId;

  const ref = doc(db, "users", usuarioId, "cows", vacaId, "applied_feeds", id);
  const snap = await getDoc(ref);
  const d = snap.data();

  document.getElementById("editInsumoId").value = id;
  document.getElementById("editInsumoNombre").value = d.feedName;
  document.getElementById("editInsumoCantidad").value = d.amountGiven;
  document.getElementById("editInsumoNotas").value = d.observations;

  new bootstrap.Modal(document.getElementById("modalEditarInsumo")).show();
};

window.guardarEdicionInsumo = async function () {

  const id = document.getElementById("editInsumoId").value;

  await updateDoc(doc(db, "users", usuarioId, "cows", window.vacaSeleccionada, "applied_feeds", id), {
    amountGiven: parseFloat(document.getElementById("editInsumoCantidad").value),
    observations: document.getElementById("editInsumoNotas").value
  });

  mostrarToast("Insumo actualizado");

  bootstrap.Modal.getInstance(document.getElementById("modalEditarInsumo")).hide();
  verHistorial(window.vacaSeleccionada);
};

window.editarEnfermedad = async function(id, vacaId) {
  window.vacaSeleccionada = vacaId;

  const ref = doc(db, "users", usuarioId, "cows", vacaId, "diseases_history", id);
  const snap = await getDoc(ref);

  const d = snap.data();

  document.getElementById("editEnfId").value = id;
  document.getElementById("editEnfNombre").value = d.name;
  document.getElementById("editEnfFecha").value = d.date.split("T")[0];
  document.getElementById("editEnfNotas").value = d.notes;

  new bootstrap.Modal(document.getElementById("modalEditarEnfermedad")).show();
};

window.guardarEdicionEnfermedad = async function () {

  const id = document.getElementById("editEnfId").value;

  await updateDoc(doc(db, "users", usuarioId, "cows", window.vacaSeleccionada, "diseases_history", id), {
    notes: document.getElementById("editEnfNotas").value,
    date: new Date(document.getElementById("editEnfFecha").value).toISOString()
  });

  mostrarToast("Enfermedad actualizada");

  bootstrap.Modal.getInstance(document.getElementById("modalEditarEnfermedad")).hide();
  verHistorial(window.vacaSeleccionada);
}; 

// ===============================
// üìä GR√ÅFICAS DE LA VACA
// ===============================
let chartVaca = null;
let tabActual = "peso";

async function cargarGraficasDeLaVaca(vacaId) {
  const uid = auth.currentUser.uid;

  const vacaRef = doc(db, "users", uid, "cows", vacaId);
  const snap = await getDoc(vacaRef);

  if (!snap.exists()) return;

  const cow = snap.data();
  window.cowGraficas = cow; // guardar por si cambian tabs

  // Detectar si es macho ‚Üí bloquear leche
  const gender = (cow.gender || "").toLowerCase();
  if (gender === "macho" || gender === "toro") {
    document.getElementById("tabLeche").style.display = "none";
    tabActual = "peso";
  } else {
    document.getElementById("tabLeche").style.display = "inline-block";
  }

  renderizarGrafica();
}


// ===============================
// üîÑ Renderizar gr√°fica
// ===============================
function renderizarGrafica() {
  const cow = window.cowGraficas;
  if (!cow) return;

  const history = tabActual === "peso"
    ? (cow.weightHistory || [])
    : (cow.milkProductionHistory || []);

    history.sort((a, b) => {
    const fechaA = new Date(a.date || 0);
    const fechaB = new Date(b.date || 0);
    return fechaA - fechaB; // Orden ascendente (m√°s antigua primero)
  });

  const labels = history.map(h => {
  if (!h.date) return "--";
  const fecha = new Date(h.date);
  return fecha.toLocaleDateString('es-CO', { 
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric' 
  });
});
  const values = history.map(h =>
    tabActual === "peso" ? h.weight : h.liters
  );

  // Historial
  let html = "";
  history.slice().reverse().forEach(h => {
  const fechaFormateada = h.date 
    ? new Date(h.date).toLocaleDateString('es-CO', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })
    : "Fecha no disponible";
    
  html += `
    <div class="p-3 border rounded mb-2 shadow-sm" style="background: linear-gradient(to right, #f8f9fa, #ffffff);">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <span class="badge bg-success mb-1">${tabActual === "peso" ? "Peso" : "Producci√≥n"}</span>
          <h6 class="mb-0 mt-1" style="color: #2e7d32; font-weight: bold;">
            ${tabActual === "peso" ? h.weight + " kg" : h.liters + " L"}
          </h6>
        </div>
        <small class="text-muted" style="font-size: 0.85rem;">
          üìÖ ${fechaFormateada}
        </small>
      </div>
    </div>
  `;
});

  document.getElementById("historialGraficas").innerHTML = html;

  // Gr√°fica
  const ctx = document.getElementById("graficaVaca").getContext("2d");

  // Ajustar ancho din√°mico seg√∫n cantidad de datos
const container = document.getElementById("canvasContainer");
const minWidth = Math.max(600, labels.length * 80); // 80px por barra
container.style.minWidth = minWidth + "px";

  if (chartVaca) chartVaca.destroy();

  chartVaca = new Chart(ctx, {
  type: "bar",
  data: {
    labels: labels,
    datasets: [{
      label: tabActual === "peso" ? "Peso (kg)" : "Leche (L/d√≠a)",
      data: values,
      backgroundColor: "rgba(46, 125, 50, 0.85)",
      borderColor: "rgba(46, 125, 50, 1)",
      borderWidth: 2,
      borderRadius: 6,
      barThickness: 45,
      maxBarThickness: 60
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: true,
        labels: {
          font: { size: 14, weight: 'bold' },
          color: '#2e7d32'
        }
      },
      tooltip: {
        backgroundColor: 'rgba(46, 125, 50, 0.95)',
        titleColor: '#fff',
        bodyColor: '#fff',
        borderColor: '#2e7d32',
        borderWidth: 2,
        padding: 12,
        displayColors: false,
        callbacks: {
          label: function(context) {
            return tabActual === "peso" 
              ? `Peso: ${context.parsed.y} kg`
              : `Producci√≥n: ${context.parsed.y} L`;
          }
        }
      }
    },
    scales: {
      y: { 
        beginAtZero: true,
        ticks: {
          font: { size: 12 },
          color: '#555'
        },
        grid: {
          color: 'rgba(0,0,0,0.05)'
        }
      },
      x: {
        ticks: {
          font: { size: 11 },
          color: '#555',
          maxRotation: 45,
          minRotation: 45
        },
        grid: {
          display: false
        }
      }
    }
  }
});
}


// ===============================
// üü¶ Tabs Peso / Leche
// ===============================
document.getElementById("tabPeso").addEventListener("click", () => {
  tabActual = "peso";
  renderizarGrafica();
});

document.getElementById("tabLeche").addEventListener("click", () => {
  tabActual = "leche";
  renderizarGrafica();
});

// ===============================
// üìÑ GENERAR REPORTE PDF
// ===============================
window.generarReportePDF = async function(vacaId) {
  
  mostrarToast("Generando reporte PDF...", "warning");
  
  const { jsPDF } = window.jspdf;
  const pdfDoc = new jsPDF();
  
  // 1Ô∏è‚É£ Obtener datos de la vaca
  const vacaRef = doc(db, "users", usuarioId, "cows", vacaId);
  const vacaSnap = await getDoc(vacaRef);
  
  if (!vacaSnap.exists()) {
    mostrarToast("Error: No se encontr√≥ la vaca", "danger");
    return;
  }
  
  const vaca = vacaSnap.data();
  let yPos = 20;
  
  // =============================
  // ENCABEZADO
  // =============================
  pdfDoc.setFontSize(22);
  pdfDoc.setTextColor(46, 125, 50);
  pdfDoc.text("REPORTE DE SIMMENTAL", 105, yPos, { align: "center" });
  
  yPos += 8;
  pdfDoc.setFontSize(10);
  pdfDoc.setTextColor(100);
  pdfDoc.text(`Generado el: ${new Date().toLocaleString('es-CO')}`, 105, yPos, { align: "center" });
  
  yPos += 15;
  
  // =============================
  // DATOS B√ÅSICOS DE LA VACA
  // =============================
  pdfDoc.setFontSize(14);
  pdfDoc.setTextColor(0);
  pdfDoc.text("DATOS BASICOS", 14, yPos);
  yPos += 8;
  
  const datosBasicos = [
    ['Nombre', vaca.name || '-'],
    ['ID Interno', vaca.internalId || '-'],
    ['Peso', `${vaca.weight || '-'} kg`],
    ['Edad', `${vaca.age || '-'} a√±os`],
    ['Genero', vaca.gender || '-'],
    ['Fecha de Nacimiento', vaca.birthDate ? new Date(vaca.birthDate).toLocaleDateString('es-CO') : '-'],
    ['Estado Reproductivo', vaca.reproductiveStatus || '-'],
    ['Produccion de Leche', `${vaca.milkProduction || '-'} L/dia`],
    ['Lactando', vaca.isLactating ? 'Si' : 'No'],
    ['Padre', vaca.fatherName || '-'],
    ['Madre', vaca.motherName || '-'],
    ['Proposito', vaca.purpose || '-'],
    ['Origen', vaca.origin || '-'],
    ['Chip ID', vaca.chipId || '-']
  ];
  
  pdfDoc.autoTable({
    startY: yPos,
    head: [['Campo', 'Valor']],
    body: datosBasicos,
    theme: 'grid',
    headStyles: { fillColor: [46, 125, 50], textColor: 255, fontSize: 10 },
    bodyStyles: { fontSize: 9 },
    margin: { left: 14, right: 14 }
  });
  
  yPos = pdfDoc.lastAutoTable.finalY + 15;
  
  // =============================
  // MEDICAMENTOS APLICADOS
  // =============================
  const medsSnap = await getDocs(
    collection(db, "users", usuarioId, "cows", vacaId, "applied_medications")
  );
  
  if (!medsSnap.empty) {
    if (yPos > 250) {
      pdfDoc.addPage();
      yPos = 20;
    }
    
    pdfDoc.setFontSize(14);
    pdfDoc.setTextColor(0);
    pdfDoc.text("MEDICAMENTOS APLICADOS", 14, yPos);
    yPos += 8;
    
    const medicamentos = [];
    medsSnap.forEach(d => {
      const m = d.data();
      medicamentos.push([
        m.name || '-',
        `${m.dose_administered_ml || 0} ml`,
        new Date(m.date).toLocaleDateString('es-CO'),
        (m.observations || 'Sin observaciones').substring(0, 50)
      ]);
    });
    
    pdfDoc.autoTable({
      startY: yPos,
      head: [['Medicamento', 'Dosis', 'Fecha', 'Observaciones']],
      body: medicamentos,
      theme: 'striped',
      headStyles: { fillColor: [76, 175, 80], fontSize: 9 },
      bodyStyles: { fontSize: 8 },
      margin: { left: 14, right: 14 }
    });
    
    yPos = pdfDoc.lastAutoTable.finalY + 15;
  }
  
  // =============================
  // INSUMOS APLICADOS
  // =============================
  const insumosSnap = await getDocs(
    collection(db, "users", usuarioId, "cows", vacaId, "applied_feeds")
  );
  
  if (!insumosSnap.empty) {
    if (yPos > 250) {
      pdfDoc.addPage();
      yPos = 20;
    }
    
    pdfDoc.setFontSize(14);
    pdfDoc.setTextColor(0);
    pdfDoc.text("INSUMOS APLICADOS", 14, yPos);
    yPos += 8;
    
    const insumos = [];
    insumosSnap.forEach(d => {
      const i = d.data();
      insumos.push([
        i.feedName || '-',
        `${i.amountGiven || 0} kg`,
        new Date(i.date).toLocaleDateString('es-CO'),
        (i.observations || 'Sin observaciones').substring(0, 50)
      ]);
    });
    
    pdfDoc.autoTable({
      startY: yPos,
      head: [['Insumo', 'Cantidad', 'Fecha', 'Observaciones']],
      body: insumos,
      theme: 'striped',
      headStyles: { fillColor: [139, 195, 74], fontSize: 9 },
      bodyStyles: { fontSize: 8 },
      margin: { left: 14, right: 14 }
    });
    
    yPos = pdfDoc.lastAutoTable.finalY + 15;
  }
  
  // =============================
  // ENFERMEDADES REGISTRADAS
  // =============================
  const enfSnap = await getDocs(
    collection(db, "users", usuarioId, "cows", vacaId, "diseases_history")
  );
  
  if (!enfSnap.empty) {
    if (yPos > 250) {
      pdfDoc.addPage();
      yPos = 20;
    }
    
    pdfDoc.setFontSize(14);
    pdfDoc.setTextColor(0);
    pdfDoc.text("ENFERMEDADES REGISTRADAS", 14, yPos);
    yPos += 8;
    
    const enfermedades = [];
    enfSnap.forEach(d => {
      const e = d.data();
      enfermedades.push([
        e.name || '-',
        e.severity || '-',
        new Date(e.date).toLocaleDateString('es-CO'),
        (e.notes || 'Sin notas').substring(0, 50)
      ]);
    });
    
    pdfDoc.autoTable({
      startY: yPos,
      head: [['Enfermedad', 'Gravedad', 'Fecha', 'Notas']],
      body: enfermedades,
      theme: 'striped',
      headStyles: { fillColor: [244, 67, 54], fontSize: 9 },
      bodyStyles: { fontSize: 8 },
      margin: { left: 14, right: 14 }
    });
    
    yPos = pdfDoc.lastAutoTable.finalY + 15;
  }
  
  // =============================
  // GR√ÅFICAS DE PESO
  // =============================
  if (vaca.weightHistory && vaca.weightHistory.length > 0) {
    
    try {
      pdfDoc.addPage();
      yPos = 20;
      
      pdfDoc.setFontSize(14);
      pdfDoc.setTextColor(0);
      pdfDoc.text("GRAFICA DE EVOLUCION DE PESO", 14, yPos);
      yPos += 10;
      
      // Crear canvas temporal
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 1000;
      tempCanvas.height = 500;
      tempCanvas.style.position = 'absolute';
      tempCanvas.style.left = '-9999px';
      document.body.appendChild(tempCanvas);
      
      const ctx = tempCanvas.getContext('2d');
      
      // Datos de peso
      const historyPeso = vaca.weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
      const labelsPeso = historyPeso.map(h => {
        if (!h.date) return "--";
        const fecha = new Date(h.date);
        return fecha.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit' });
      });
      const valuesPeso = historyPeso.map(h => h.weight);
      
      // Crear gr√°fica
      const tempChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labelsPeso,
          datasets: [{
            label: "Peso (kg)",
            data: valuesPeso,
            backgroundColor: "rgba(46, 125, 50, 0.2)",
            borderColor: "rgba(46, 125, 50, 1)",
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: 5,
            pointBackgroundColor: "rgba(46, 125, 50, 1)"
          }]
        },
        options: {
          responsive: false,
          animation: false,
          plugins: {
            legend: { 
              display: true,
              labels: { font: { size: 14 } }
            }
          },
          scales: {
            y: { 
              beginAtZero: false,
              ticks: { font: { size: 12 } }
            },
            x: {
              ticks: { font: { size: 10 } }
            }
          }
        }
      });
      
      // Esperar renderizado
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // Capturar y agregar imagen
      const imgData = tempCanvas.toDataURL("image/png", 1.0);
      pdfDoc.addImage(imgData, 'PNG', 14, yPos, 180, 90);
      
      // Limpiar
      tempChart.destroy();
      document.body.removeChild(tempCanvas);
      
    } catch (error) {
      console.error("Error al generar gr√°fica de peso:", error);
      pdfDoc.setFontSize(10);
      pdfDoc.setTextColor(200, 0, 0);
      pdfDoc.text("No se pudo generar la grafica de peso", 14, yPos);
    }
  }
  
  // =============================
  // GR√ÅFICAS DE LECHE (solo si es hembra)
  // =============================
  const gender = (vaca.gender || "").toLowerCase();
  if (gender === "hembra" && vaca.milkProductionHistory && vaca.milkProductionHistory.length > 0) {
    
    try {
      pdfDoc.addPage();
      yPos = 20;
      
      pdfDoc.setFontSize(14);
      pdfDoc.setTextColor(0);
      pdfDoc.text("GRAFICA DE PRODUCCION DE LECHE", 14, yPos);
      yPos += 10;
      
      // Crear canvas temporal
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 1000;
      tempCanvas.height = 500;
      tempCanvas.style.position = 'absolute';
      tempCanvas.style.left = '-9999px';
      document.body.appendChild(tempCanvas);
      
      const ctx = tempCanvas.getContext('2d');
      
      // Datos de leche
      const historyLeche = vaca.milkProductionHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
      const labelsLeche = historyLeche.map(h => {
        if (!h.date) return "--";
        const fecha = new Date(h.date);
        return fecha.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit' });
      });
      const valuesLeche = historyLeche.map(h => h.liters);
      
      // Crear gr√°fica
      const tempChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: labelsLeche,
          datasets: [{
            label: "Produccion (L/dia)",
            data: valuesLeche,
            backgroundColor: "rgba(33, 150, 243, 0.7)",
            borderColor: "rgba(33, 150, 243, 1)",
            borderWidth: 2
          }]
        },
        options: {
          responsive: false,
          animation: false,
          plugins: {
            legend: { 
              display: true,
              labels: { font: { size: 14 } }
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              ticks: { font: { size: 12 } }
            },
            x: {
              ticks: { font: { size: 10 } }
            }
          }
        }
      });
      
      // Esperar renderizado
      await new Promise(resolve => setTimeout(resolve, 800));
      
      // Capturar y agregar imagen
      const imgData = tempCanvas.toDataURL("image/png", 1.0);
      pdfDoc.addImage(imgData, 'PNG', 14, yPos, 180, 90);
      
      // Limpiar
      tempChart.destroy();
      document.body.removeChild(tempCanvas);
      
    } catch (error) {
      console.error("Error al generar gr√°fica de leche:", error);
    }
  }
  
  // =============================
  // GUARDAR PDF
  // =============================
  const nombreArchivo = `Reporte_${vaca.name || 'Vaca'}_${new Date().getTime()}.pdf`;
  pdfDoc.save(nombreArchivo);
  
  mostrarToast("Reporte generado exitosamente", "success");
};

</script>

<script>
  const btnFlotante = document.getElementById("btn-flotante");
  const seccionVacas = document.getElementById("tabla-simmental"); // Cambia el ID si tu tabla se llama distinto

  function scrollToTabla() {
    if (seccionVacas) {
      seccionVacas.scrollIntoView({ behavior: "smooth" });
    }
  }

  window.addEventListener("scroll", () => {
  if (!seccionVacas) return;

  const rect = seccionVacas.getBoundingClientRect();
  const alturaVentana = window.innerHeight;

  // Si la parte superior de la tabla est√° dentro del √°rea visible, ocultar el bot√≥n
  if (rect.top < alturaVentana && rect.bottom > 0) {
    btnFlotante.classList.add("oculto");
  } else {
    btnFlotante.classList.remove("oculto");
  }
  });
</script>

</body>
</html>