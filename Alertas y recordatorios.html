<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agrocontrol</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet"/>

  <!-- Tu CSS -->
  <link rel="stylesheet" href="css/Alertas y recordatorios.css"/>
</head>
<body>
 <header>

 <nav class="navbar navbar-expand-lg ">
  <div class="container-fluid ">

    <a class="navbar-brand" >
      <img src="img/Logo agrocontrol.png" alt="Bootstrap" width="100" height="100">
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

         <li class="nav-item">
          <a class="nav-link" href="contenidoPrincipal.html" > Inicio </a>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Vacas
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="Jersey.html">Jersey</a></li>
            <li><hr class="dropdown-divider" ></li>
            <li><a class="dropdown-item" href="Girolando.html">Girolando</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="Gyr.html">Gyr</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="simmental.html">Simmental</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="#">Medicamentos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Insumos</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="enfermedades.html">Enfermedades</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="Alertas y recordatorios.html" > Alertas y Recordatorios </a>
        </li>

         <li class="nav-item">
          <a class="nav-link" href="control.html" > Control </a>
        </li>
 
        <li class="nav-item">
          <a class="nav-link" href="index.html" > Usuario </a>
        </li>
      </ul>
      <form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Search"/>
        <button class="btn btn-outline-success" type="submit">Buscar</button> 
      </form> <br>
    </div>
  </div>
 </nav>
  </header>

<main>
  <div class="container mt-4 text-center">
    <h2 class="mb-4">📅 Calendario de Recordatorios</h2>
    <button class="btn btn-success mb-3" id="btnNuevo">➕ Nuevo Recordatorio</button>
    <div id="calendar"></div>
  </div>

  <!-- Modal crear / editar -->
  <div class="modal fade" id="recordatorioModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="recordatorioForm" class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Nuevo Recordatorio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editingId">
          <div class="mb-3">
            <label class="form-label">Fecha y Hora</label>
            <input type="datetime-local" id="fechaHora" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input type="text" id="nombre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Asunto</label>
            <select id="asunto" class="form-select">
              <option value="Reunión">Reunión</option>
              <option value="Pago">Pago</option>
              <option value="Entrega">Entrega</option>
              <option value="Otro">Otro...</option>
            </select>
            <input type="text" id="asuntoOtro" class="form-control mt-2 d-none" placeholder="Escribe el asunto">
          </div>
          <div class="mb-3">
            <label class="form-label">Observaciones</label>
            <textarea id="observaciones" class="form-control" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal detalle -->
  <div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Detalle del Recordatorio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>Nombre:</strong> <span id="detalleNombre"></span></p>
          <p><strong>Fecha:</strong> <span id="detalleFecha"></span></p>
          <p><strong>Asunto:</strong> <span id="detalleAsunto"></span></p>
          <p><strong>Observaciones:</strong> <span id="detalleObs"></span></p>
        </div>
        <div class="modal-footer">
          <button id="btnEliminar" type="button" class="btn btn-danger">Eliminar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- audio alerta -->
  <audio id="alertSound" src="audio/Sonido Musica Waos pa la alerta.mpeg" preload="auto"></audio>
</main>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<!-- FullCalendar Global -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<!-- Firebase + lógica -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc 
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } 
    from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB7WdEEYxvxYDe1bsrcLg1lQNa1wJbBXZ8",
    authDomain: "agrocontrol-8550b.firebaseapp.com",
    projectId: "agrocontrol-8550b",
    storageBucket: "agrocontrol-8550b.appspot.com",
    messagingSenderId: "540741735209",
    appId: "1:540741735209:web:7a44dff52d07641cc91d38",
    measurementId: "G-7FBMJ1WNPZ"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const calendarEl = document.getElementById("calendar");
  const alertSound = document.getElementById("alertSound");
  const recordatorioModal = new bootstrap.Modal(document.getElementById("recordatorioModal"));
  const detalleModal = new bootstrap.Modal(document.getElementById("detalleModal"));

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: "dayGridMonth",
    locale: "es",
    headerToolbar: { 
      left: "prev,next today", 
      center: "title", 
      right: "dayGridMonth,timeGridWeek,timeGridDay" 
    },
    dateClick: (info) => {
      document.getElementById("fechaHora").value = info.dateStr + "T09:00";
      document.getElementById("editingId").value = "";
      recordatorioModal.show();
    },
    eventClick: (info) => {
      const ev = info.event;
      document.getElementById("detalleNombre").innerText = ev.extendedProps.nombre || ev.title;
      document.getElementById("detalleFecha").innerText = ev.start ? ev.start.toLocaleString() : ev.startStr;
      document.getElementById("detalleAsunto").innerText = ev.extendedProps?.asunto || "";
      document.getElementById("detalleObs").innerText = ev.extendedProps?.observaciones || "";

      document.getElementById("btnEliminar").onclick = async () => {
        const user = auth.currentUser;
        if (!user) return alert("Debes iniciar sesión");
        await deleteDoc(doc(db, "usuarios", user.uid, "recordatorios", ev.id));
        detalleModal.hide();
      };
      detalleModal.show();
    }
  });
  calendar.render();

  document.getElementById("btnNuevo").addEventListener("click", () => {
    document.getElementById("editingId").value = "";
    recordatorioModal.show();
  });

  document.getElementById("asunto").addEventListener("change", function() {
    document.getElementById("asuntoOtro").classList.toggle("d-none", this.value !== "Otro");
  });

  // 🔑 Esperamos a que el usuario esté logueado
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      console.warn("⚠️ No hay usuario logueado. No se cargarán recordatorios.");
      return;
    }

    const colRef = collection(db, "usuarios", user.uid, "recordatorios");

    // Guardar recordatorio
    document.getElementById("recordatorioForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const idEditing = document.getElementById("editingId").value || null;
      const fechaHora = document.getElementById("fechaHora").value;
      const nombre = document.getElementById("nombre").value.trim();
      let asunto = document.getElementById("asunto").value;
      if (asunto === "Otro") asunto = document.getElementById("asuntoOtro").value.trim();
      const observaciones = document.getElementById("observaciones").value.trim();

      if (!fechaHora || !nombre) {
        alert("Fecha y nombre son obligatorios");
        return;
      }

      const payload = { 
        title: `${asunto} - ${nombre}`, 
        nombre, 
        asunto, 
        observaciones, 
        start: new Date(fechaHora).toISOString(), 
        createdAt: new Date().toISOString() 
      };

      if (idEditing) {
        await updateDoc(doc(db, "usuarios", user.uid, "recordatorios", idEditing), payload);
      } else {
        const docRef = await addDoc(colRef, payload);
        calendar.addEvent({ 
          id: docRef.id, 
          title: payload.title, 
          start: payload.start, 
          extendedProps: { nombre, asunto, observaciones } 
        });
      }

      recordatorioModal.hide();
      e.target.reset();
    });

    // 🔄 Escuchar cambios en tiempo real
    onSnapshot(colRef, (snapshot) => {
      calendar.getEvents().forEach(ev => ev.remove());
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        calendar.addEvent({ 
          id: docSnap.id, 
          title: d.title || d.nombre, 
          start: d.start, 
          extendedProps: { 
            nombre: d.nombre, 
            asunto: d.asunto, 
            observaciones: d.observaciones 
          } 
        });
      });
    });
  });

  // ⏰ Revisar recordatorios cercanos cada 30s
  setInterval(() => {
    const ahora = new Date();
    calendar.getEvents().forEach(ev => {
      const evDate = ev.start ? new Date(ev.start) : null;
      if (!evDate) return;
      const diff = (evDate - ahora) / 1000;
      if (diff >= 0 && diff <= 30) {
        if ("Notification" in window && Notification.permission === "granted") {
          new Notification("Recordatorio Agrocontrol", { body: ev.title });
        } else {
          console.log("Recordatorio:", ev.title);
        }
        try { alertSound.play(); } catch {}
      }
    });
  }, 30000);

  if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
  }
</script>

</body>
</html>
