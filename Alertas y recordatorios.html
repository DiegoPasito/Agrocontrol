<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agrocontrol</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet"/>

  <!-- Tu CSS -->
  <link rel="stylesheet" href="css/Alertas y recordatorios.css"/>
</head>
<body>
 <header>

 <nav class="navbar navbar-expand-lg ">
  <div class="container-fluid ">

    <a class="navbar-brand" >
      <img src="img/Logo agrocontrol.png" alt="Bootstrap" width="100" height="100">
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

         <li class="nav-item">
          <a class="nav-link" href="contenidoPrincipal.html" > Inicio </a>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Vacas
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="Jersey.html">Jersey</a></li>
            <li><hr class="dropdown-divider" ></li>
            <li><a class="dropdown-item" href="Girolando.html">Girolando</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="Gyr.html">Gyr</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="simmental.html">Simmental</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="Medicamentos.html">Medicamentos</a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link" href="#">Insumos</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="enfermedades.html">Enfermedades</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="Alertas y recordatorios.html" > Alertas y Recordatorios </a>
        </li>

         <li class="nav-item">
          <a class="nav-link" href="control.html" > Control </a>
        </li>
 

        <li class="nav-item">
          <a class="nav-link" href="Perfilusuario.html" > Perfil </a>
        </li>

      </ul>
       
    </div>
  </div>
 </nav>
  </header>

<main>
  <div class="container mt-4 text-center">
    <h2 class="mb-4">ðŸ“… Calendario de Recordatorios</h2>
    <button class="btn btn-success mb-3" id="btnNuevo">âž• Nuevo Recordatorio</button>
    <div id="calendar"></div>
  </div>

  <!-- Modal crear / editar -->
  <div class="modal fade" id="recordatorioModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="recordatorioForm" class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Nuevo Recordatorio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editingId">
          <div class="mb-3">
            <label class="form-label">Fecha y Hora</label>
            <input type="datetime-local" id="fechaHora" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">TÃ­tulo</label>
            <input type="text" id="titulo" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">DescripciÃ³n</label>
            <textarea id="descripcion" class="form-control" rows="3" placeholder="Opcional"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal detalle -->
  <div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Detalle del Recordatorio</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p><strong>TÃ­tulo:</strong> <span id="detalleTitulo"></span></p>
          <p><strong>Fecha:</strong> <span id="detalleFecha"></span></p>
          <p><strong>DescripciÃ³n:</strong> <span id="detalleDesc"></span></p>
        </div>
        <div class="modal-footer">
          <button id="btnEliminar" type="button" class="btn btn-danger">Eliminar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ”” audio alerta -->
  <audio id="alertSound" src="audio/Sonido Musica Waos pa la alerta.mpeg" preload="auto"></audio>
</main>

<!-- Dependencias -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, Timestamp  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzonIFbhlOnnIs9xG9Lb4uBJHLrhCi3qU",
  authDomain: "web-y-movil-agroncontrol.firebaseapp.com",
  projectId: "web-y-movil-agroncontrol",
  storageBucket: "web-y-movil-agroncontrol.firebasestorage.app",
  messagingSenderId: "180502593551",
  appId: "1:180502593551:web:f4ae5111ac99ec70fa237a",
  measurementId: "G-BJ9G9WSKNY"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const calendarEl = document.getElementById("calendar");
const alertSound = document.getElementById("alertSound");
const recordatorioModal = new bootstrap.Modal(document.getElementById("recordatorioModal"));
const detalleModal = new bootstrap.Modal(document.getElementById("detalleModal"));

const calendar = new FullCalendar.Calendar(calendarEl, {
  initialView: "dayGridMonth",
  locale: "es",
  headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,timeGridWeek,timeGridDay" },
  dateClick: (info) => {
    document.getElementById("fechaHora").value = info.dateStr + "T09:00";
    document.getElementById("editingId").value = "";
    recordatorioModal.show();
  },
  eventClick: (info) => {
    const ev = info.event;
    document.getElementById("detalleTitulo").innerText = ev.title;
    document.getElementById("detalleFecha").innerText = ev.start.toLocaleString();
    document.getElementById("detalleDesc").innerText = ev.extendedProps.description || "Sin descripciÃ³n";
    document.getElementById("btnEliminar").onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert("Debes iniciar sesiÃ³n");
      await deleteDoc(doc(db, "users", user.uid, "reminders", ev.id));
      detalleModal.hide();
    };
    detalleModal.show();
  }
});
calendar.render();

document.getElementById("btnNuevo").addEventListener("click", () => {
  document.getElementById("editingId").value = "";
  recordatorioModal.show();
});

onAuthStateChanged(auth, (user) => {
  if (!user) {
    console.warn("âš ï¸ No hay usuario logueado.");
    return;
  }

  const colRef = collection(db, "users", user.uid, "reminders");

  // Guardar recordatorio
  document.getElementById("recordatorioForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const idEditing = document.getElementById("editingId").value || null;
    const fechaHora = document.getElementById("fechaHora").value;
    const titulo = document.getElementById("titulo").value.trim();
    const descripcion = document.getElementById("descripcion").value.trim();

    if (!fechaHora || !titulo) return alert("âš ï¸ Completa los campos obligatorios.");

    const payload = {
      title: titulo,
      description: descripcion,
      dateTime: Timestamp.fromDate(new Date(fechaHora)),
      createdAt: Timestamp.now(),
    };

    if (idEditing) {
      await updateDoc(doc(db, "users", user.uid, "reminders", idEditing), payload);
    } else {
      const docRef = await addDoc(colRef, payload);
      calendar.addEvent({
        id: docRef.id,
        title: titulo,
        start: payload.dateTime,
        extendedProps: { description: descripcion },
      });
    }

    recordatorioModal.hide();
    e.target.reset();
  });

  // Escuchar cambios en tiempo real
  onSnapshot(colRef, (snapshot) => {
    calendar.getEvents().forEach(ev => ev.remove());
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      calendar.addEvent({
        id: docSnap.id,
        title: d.title,
        start: d.dateTime.toDate(),
        extendedProps: { description: d.description },
      });
    });
  });
});

// Revisar recordatorios cercanos cada 10s
setInterval(() => {
  const ahora = new Date();
  calendar.getEvents().forEach(ev => {
    const evDate = new Date(ev.start);
    const diff = (evDate - ahora) / 1000; // segundos
    if (diff >= 0 && diff <= 15) { // margen 15 s
      if ("Notification" in window && Notification.permission === "granted") {
        new Notification("Recordatorio", { body: ev.title });
      } else {
        alert("ðŸ”” Recordatorio: " + ev.title);
      }
      try { alertSound.play(); } catch {}
    }
  });
}, 5000); // revisa cada 5 s

// Pedir permisos de notificaciÃ³n al cargar
if ("Notification" in window) {
  if (Notification.permission === "default") {
    Notification.requestPermission().then(permission => {
      if (permission !== "granted") {
        console.warn("ðŸš« Permiso de notificaciÃ³n denegado. Se usarÃ¡ alerta visual.");
      }
    });
  }
}
</script>

</body>
</html>
