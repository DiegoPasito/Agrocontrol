<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agrocontrol</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.min.css" rel="stylesheet">

    <link rel="stylesheet" href="css/Alertas y recordatorios.css">

</head>
<body>
   <header>

 <nav class="navbar navbar-expand-lg ">
  <div class="container-fluid ">

    <a class="navbar-brand" >
      <img src="img/Agrocontrol verde bonito.jpg" alt="Bootstrap" width="100" height="100">
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

         <li class="nav-item">
          <a class="nav-link" href="contenidoPrincipal.html" > Inicio </a>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Vacas
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="Jersey.html">Jersey</a></li>
            <li><hr class="dropdown-divider" ></li>
            <li><a class="dropdown-item" href="Girolando.html">Girolando</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="Gyr.html">Gyr</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="simmental.html">Simmental</a></li>
          </ul>
        </li>
        <li class="nav-item">
          <a class="nav-link " href="#">Medicamentos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Insumos</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="enfermedades.html">Enfermedades</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="Alertas y recordatorios.html" > Alertas y Recordatorios </a>
        </li>

         <li class="nav-item">
          <a class="nav-link" href="control.html" > Control </a>
        </li>
 
        <li class="nav-item">
          <a class="nav-link" href="index.html" > Usuario </a>
        </li>
      </ul>
      <form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Search"/>
        <button class="btn btn-outline-success" type="submit">Buscar</button> 
      </form> <br>
    </div>
  </div>
 </nav>
  </header> 

  <main>
    <div class="container mt-4 text-center">
      <h2 class="mb-4">ðŸ“… Calendario de Recordatorios</h2>

      <!-- botÃ³n para abrir modal manualmente (opcional) -->
      <button class="btn btn-success mb-3" id="btnNuevo">âž• Nuevo Recordatorio</button>

      <div id="calendar"></div>
    </div>

    <!-- Modal crear / editar -->
    <div class="modal fade" id="recordatorioModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form id="recordatorioForm" class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">Nuevo Recordatorio</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editingId" value="">
            <div class="mb-3">
              <label class="form-label">Fecha y Hora</label>
              <input type="datetime-local" id="fechaHora" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" id="nombre" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Asunto</label>
              <select id="asunto" class="form-select">
                <option value="ReuniÃ³n">ReuniÃ³n</option>
                <option value="Pago">Pago</option>
                <option value="Entrega">Entrega</option>
                <option value="Otro">Otro...</option>
              </select>
              <input type="text" id="asuntoOtro" class="form-control mt-2 d-none" placeholder="Escribe el asunto">
            </div>
            <div class="mb-3">
              <label class="form-label">Observaciones</label>
              <textarea id="observaciones" class="form-control" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal detalle -->
    <div class="modal fade" id="detalleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Detalle del Recordatorio</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p><strong>Nombre:</strong> <span id="detalleNombre"></span></p>
            <p><strong>Fecha:</strong> <span id="detalleFecha"></span></p>
            <p><strong>Asunto:</strong> <span id="detalleAsunto"></span></p>
            <p><strong>Observaciones:</strong> <span id="detalleObs"></span></p>
          </div>
          <div class="modal-footer">
            <button id="btnEliminar" type="button" class="btn btn-danger">Eliminar</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- audio alerta -->
    <audio id="alertSound" src="audio/Sonido Musica Waos pa la alerta.mpeg" preload="auto"></audio>
  </main>

  <!-- Scripts: FullCalendar primero (global) y bootstrap bundle ya cargado en head -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/main.global.min.js"></script>

  <!-- Firebase + app script (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      onSnapshot,
      deleteDoc,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // --- TU CONFIG (usa la tuya; estoy usando la que mencionaste antes) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB7WdEEYxvxYDe1bsrcLg1lQNa1wJbBXZ8",
      authDomain: "agrocontrol-8550b.firebaseapp.com",
      projectId: "agrocontrol-8550b",
      storageBucket: "agrocontrol-8550b.appspot.com",
      messagingSenderId: "540741735209",
      appId: "1:540741735209:web:7a44dff52d07641cc91d38",
      measurementId: "G-7FBMJ1WNPZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const colRef = collection(db, "recordatorios");

    // Referencias DOM
    const calendarEl = document.getElementById("calendar");
    const alertSound = document.getElementById("alertSound");
    const recordatorioModalEl = document.getElementById("recordatorioModal");
    const recordatorioModal = new bootstrap.Modal(recordatorioModalEl);
    const detalleModal = new bootstrap.Modal(document.getElementById("detalleModal"));

    // Inicializar FullCalendar
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: "dayGridMonth",
      locale: "es",
      headerToolbar: {
        left: "prev,next today",
        center: "title",
        right: "dayGridMonth,timeGridWeek,timeGridDay"
      },
      dateClick: function(info) {
        // abrir modal con fecha preseleccionada
        // set value for datetime-local as YYYY-MM-DDTHH:MM
        const fechaDefault = info.dateStr + "T09:00";
        document.getElementById("fechaHora").value = fechaDefault;
        document.getElementById("editingId").value = "";
        recordatorioModal.show();
      },
      eventClick: function(info) {
        // mostrar detalle modal (traemos datos del evento)
        const ev = info.event;
        document.getElementById("detalleNombre").innerText = ev.title;
        // formato de fecha
        const d = ev.start;
        document.getElementById("detalleFecha").innerText = d ? d.toLocaleString() : ev.startStr;
        document.getElementById("detalleAsunto").innerText = ev.extendedProps?.asunto || "";
        document.getElementById("detalleObs").innerText = ev.extendedProps?.observaciones || "";

        // configurar botÃ³n eliminar
        document.getElementById("btnEliminar").onclick = async () => {
          try {
            await deleteDoc(doc(db, "recordatorios", ev.id));
            detalleModal.hide();
          } catch (err) {
            console.error(err);
            alert("Error al eliminar: " + err.message);
          }
        };

        // abrir modal detalle
        detalleModal.show();
      }
    });

    calendar.render();

    // botÃ³n para abrir modal manualmente
    document.getElementById("btnNuevo").addEventListener("click", () => {
      document.getElementById("editingId").value = "";
      recordatorioModal.show();
    });

    // mostrar input "Otro asunto"
    document.getElementById("asunto").addEventListener("change", function() {
      document.getElementById("asuntoOtro").classList.toggle("d-none", this.value !== "Otro");
    });

    // Guardar/Editar recordatorio
    document.getElementById("recordatorioForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const idEditing = document.getElementById("editingId").value || null;
      const fechaHora = document.getElementById("fechaHora").value;
      const nombre = document.getElementById("nombre").value.trim();
      let asunto = document.getElementById("asunto").value;
      if (asunto === "Otro") asunto = document.getElementById("asuntoOtro").value.trim();
      const observaciones = document.getElementById("observaciones").value.trim();

      if (!fechaHora || !nombre) {
        alert("Fecha y nombre son obligatorios");
        return;
      }

      const payload = {
        title: `${asunto} - ${nombre}`,
        nombre,
        asunto,
        observaciones,
        start: fechaHora,
        createdAt: new Date().toISOString()
      };

      try {
        if (idEditing) {
          // editar: actualizar documento y evento en calendario
          const docRef = doc(db, "recordatorios", idEditing);
          await updateDoc(docRef, payload);
          // el onSnapshot se encargarÃ¡ de refrescar el calendario
        } else {
          // crear nuevo
          const docRef = await addDoc(colRef, payload);
          // onSnapshot aÃ±adirÃ¡ el evento tambiÃ©n; podemos aÃ±adirlo ya para feedback instantÃ¡neo:
          calendar.addEvent({
            id: docRef.id,
            title: payload.title,
            start: payload.start,
            extendedProps: { asunto: payload.asunto, observaciones: payload.observaciones }
          });
        }

        recordatorioModal.hide();
        e.target.reset();
      } catch (err) {
        console.error(err);
        alert("Error guardando: " + err.message);
      }
    });

    // Escuchar colecciÃ³n en tiempo real y (re)renderizar eventos
    onSnapshot(colRef, (snapshot) => {
      // limpiar
      calendar.getEvents().forEach(ev => ev.remove());
      // agregar cada doc como evento
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        // campo "start" en Firestore lo guardamos como ISO string (datetime-local produce ISO-like "YYYY-MM-DDTHH:mm")
        calendar.addEvent({
          id: docSnap.id,
          title: d.title || (d.asunto ? `${d.asunto} - ${d.nombre}` : d.nombre),
          start: d.start || d.fecha || d.createdAt || null,
          extendedProps: { nombre: d.nombre, asunto: d.asunto, observaciones: d.observaciones }
        });
      });
    });

    // comprobador de notificaciones (cada 30s) â†’ mejorar con workers para producciÃ³n
    setInterval(() => {
      const ahora = new Date();
      calendar.getEvents().forEach(ev => {
        const evDate = ev.start ? new Date(ev.start) : null;
        if (!evDate) return;
        const diff = (evDate - ahora) / 1000; // segundos
        // disparar notificaciÃ³n si estÃ¡ dentro de prÃ³ximos 30s
        if (diff >= 0 && diff <= 30) {
          // mostrar una notificaciÃ³n visual (toast simple)
          if (Notification && Notification.permission === "granted") {
            new Notification("Recordatorio Agrocontrol", { body: ev.title });
          } else {
            // fallback: simple alert no intrusiva + sonido
            console.log("Recordatorio:", ev.title);
          }
          // sonido (nota: autoplay puede bloquearse hasta interacciÃ³n)
          try { alertSound.play(); } catch (e) {}
        }
      });
    }, 30000);

    // pedir permiso de notificaciones (opcional)
    if ("Notification" in window && Notification.permission !== "granted") {
      Notification.requestPermission().then(perm => console.log("Permiso notificaciones:", perm));
    }
  </script>

</body>
</html>