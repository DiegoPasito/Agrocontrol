<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cambio de Contraseña - BoviGestf</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/usuario.css">

<style>
  .same-size-btn {
    min-width: 200px; /* Mismo largo */
    padding-top: 0.45rem;   /* Altura normal */
    padding-bottom: 0.45rem;
    font-size: 1rem; /* Tamaño normal del texto */
  }

#custom-prompt-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.65);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#custom-prompt-box {
  background: white;
  padding: 40px;
  width: 450px;     /* MÁS ANCHO */
  max-width: 90%;
  border-radius: 18px;  /* MÁS REDONDO */
  box-shadow: 0px 4px 20px rgba(0,0,0,0.3);
  text-align: center;
  animation: scaleIn 0.25s ease-out;
}

#custom-prompt-box h3 {
  font-size: 24px;   /* MÁS GRANDE */
  font-weight: bold;
  margin-bottom: 15px;
  color: #333;
}

#custom-prompt-box p {
  font-size: 18px;   /* MÁS GRANDE */
  margin-bottom: 25px;
}

#custom-prompt-btn {
  background: #28a745;
  color: white;
  border: none;
  padding: 14px 28px; /* MÁS GRANDE */
  font-size: 18px;    /* MÁS GRANDE */
  border-radius: 10px;
  cursor: pointer;
  transition: 0.25s;
  width: 100%;
}

#custom-prompt-btn:hover {
  background: #218838;
  transform: scale(1.03);
}

@keyframes scaleIn {
  from { transform: scale(0.85); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

</style>


</head>
<body>

   <div class="login-container">
    <div class="row g-0">
      <!-- Sección del Formulario (Izquierda) -->
      <div class="col-md-6">
        <div class="login-form-section">
          <div class="text-center mb-4">
            <img src="img/Logo Agro sin letras.png" alt="Logo Agrocontrol" class="rounded-circle form-logo" onerror="this.style.display='none'">
            <h3 class="mt-3 mb-1" >BoviGestf</h3>
            <p class="text-muted">Cambiar Contraseña</p>
          </div>

          <form>
            <div class="mb-3">
              <label for="password" class="form-label">Contraseña Actual</label>
              <input type="password" class="form-control" id="contra-actual" placeholder="••••••••" required>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Contraseña Nueva</label>
              <input type="password" class="form-control" id="contra-nueva" placeholder="••••••••" required>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Confirmar Contraseña</label>
              <input type="password" class="form-control" id="confirmar-contra" placeholder="••••••••" required>
            </div>
            
            <div class="d-flex justify-content-center gap-3 mb-3">
              <button type="button" id="volver-btn" class="btn btn-outline-secondary same-size-btn">
              Volver
              </button>

              <button type="button" id="cambiar-btn" class="btn btn-success same-size-btn">
              Cambiar Contraseña
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Sección Visual (Derecha) -->
      <div class="col-md-6">
        <div class="login-visual-section">
          <div class="visual-content">
            <div class="visual-logo">
              <img src="img/Logo Agro sin letras.png" alt="Logo Agrocontrol" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ccircle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%2336ac42%22/%3E%3Cpath d=%22M50 30 L50 70 M30 50 L70 50%22 stroke=%22white%22 stroke-width=%224%22/%3E%3C/svg%3E'">
            </div>
            <h2 class="mb-3">Bienvenido a BoviGestf</h2>
            <p class="mb-4">Gestiona tu producción ganadera de manera eficiente y efectiva</p>
            <div class="mt-4">
              <p class="small mb-1">✓ Control total de tu ganado</p>
              <p class="small mb-1">✓ Seguimiento en tiempo real</p>
              <p class="small">✓ Reportes detallados</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =======================
   MODAL DE MENSAJE GLOBAL
========================== -->
<div id="custom-prompt-overlay">
  <div id="custom-prompt-box">
    <h3 id="custom-prompt-title">Mensaje</h3>
    <p id="custom-prompt-message"></p>
    <button id="custom-prompt-btn">Aceptar</button>
  </div>
</div>

  <!-- Firebase SDK -->
<script type="module">
  // Importar Firebase desde CDN
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { 
    getAuth,
    EmailAuthProvider,
    reauthenticateWithCredential,
    updatePassword
  } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

  // Configuración de Firebase
  const firebaseConfig = {
      apiKey: "AIzaSyAzonIFbhlOnnIs9xG9Lb4uBJHLrhCi3qU",
      authDomain: "web-y-movil-agroncontrol.firebaseapp.com",
      projectId: "web-y-movil-agroncontrol",
      storageBucket: "web-y-movil-agroncontrol.firebasestorage.app",
      messagingSenderId: "180502593551",
      appId: "1:180502593551:web:f4ae5111ac99ec70fa237a",
      measurementId: "G-BJ9G9WSKNY"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Inputs
  const contraActual = document.getElementById("contra-actual");
  const contraNueva = document.getElementById("contra-nueva");
  const confirmarContra = document.getElementById("confirmar-contra");

  // Botones
  const cambiarBtn = document.getElementById("cambiar-btn");
  const volverBtn = document.getElementById("volver-btn");

  // Prompt global
function showPrompt(message, onAccept = null) {
  const overlay = document.getElementById("custom-prompt-overlay");
  const msgBox = document.getElementById("custom-prompt-message");
  const btn = document.getElementById("custom-prompt-btn");

  msgBox.textContent = message;
  overlay.style.display = "flex";

  btn.onclick = () => {
    overlay.style.display = "none";
    if (onAccept) onAccept();
  };
}

  // ===============================
  //  BOTÓN VOLVER
  // ===============================
  volverBtn.addEventListener("click", () => {
    window.location.href = "Perfilusuario.html";
  });

  // ===============================
  //  CAMBIAR CONTRASEÑA
  // ===============================
  cambiarBtn.addEventListener("click", async (e) => {
  e.preventDefault();

  const user = auth.currentUser;

  if (!user) {
    showPrompt("No hay usuario autenticado.");
    return;
  }

  const actual = contraActual.value.trim();
  const nueva = contraNueva.value.trim();
  const confirmar = confirmarContra.value.trim();

  if (!actual || !nueva || !confirmar) {
    showPrompt("Todos los campos son obligatorios.");
    return;
  }

  if (nueva !== confirmar) {
    showPrompt("Las contraseñas nuevas no coinciden.");
    return;
  }

  if (nueva.length < 6) {
    showPrompt("La contraseña debe tener al menos 6 caracteres.");
    return;
  }

  try {
    // Reautenticar
    const credencial = EmailAuthProvider.credential(user.email, actual);
    await reauthenticateWithCredential(user, credencial);

    // Actualizar
    await updatePassword(user, nueva);

    showPrompt("Contraseña actualizada correctamente.", () => {
      window.location.href = "Perfilusuario.html";
    });

  } catch (error) {
    console.error("Error cambiando contraseña:", error);

    if (error.code === "auth/wrong-password") {
      showPrompt("La contraseña actual es incorrecta.");
    } else if (error.code === "auth/weak-password") {
      showPrompt("La nueva contraseña es demasiado débil.");
    } else {
      showPrompt("Ocurrió un error. Inténtalo nuevamente.");
    }
  }
});
</script>
</body>
</html>