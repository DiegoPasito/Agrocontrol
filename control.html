<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BoviGestf</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/control.css">

</head>
   <header>

 <nav class="navbar navbar-expand-lg ">
  <div class="container-fluid ">

    <a class="navbar-brand" >
      <img src="img/LogoAgrocontrol.png" alt="Bootstrap" width="100" height="100">
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

         <li class="nav-item">
          <a class="nav-link" href="contenidoPrincipal.html" > Inicio </a>
        </li>

        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            Vacas
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="Jersey.html">Jersey</a></li>
            <li><hr class="dropdown-divider" ></li>
            <li><a class="dropdown-item" href="Girolando.html">Girolando</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="Gyr.html">Gyr</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="simmental.html">Simmental</a></li>
          </ul>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="Medicamentos.html">Medicamentos</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="insumos.html">Insumos</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="enfermedades.html">Enfermedades</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="Alertas y recordatorios.html" > Recordatorios </a>
        </li>

         <li class="nav-item">
          <a class="nav-link" href="control.html" > Control </a>
        </li>

        <li class="nav-item">
              <a class="nav-link" href="Costos.html">Costos</a>
            </li>
 

        <li class="nav-item">
          <a class="nav-link" href="Perfilusuario.html" > Perfil </a>
        </li>

      </ul>

      <!-- üì± BOT√ìN DESCARGAR APP (Alineado a la derecha) -->
      <div class="ms-auto">
        <button class="btn-descargar-app" data-bs-toggle="modal" data-bs-target="#modalQR">
          <span class="download-icon">üì±</span>
          <span class="download-text">Descargar App</span>
        </button>
      </div>
       
    </div>
  </div>
 </nav>
  </header> 
<body >

<main>
        <div class="control-container">
            <h1 class="page-title">Control de Ganado</h1>
            <p class="page-subtitle">Registra y gestiona la informaci√≥n de tus vacas</p>

            <div id="mensaje"></div>

            <div class="form-card">
                <div class="icon-cow">üêÑ</div>
                
                <form id="form-vaca">
                    <!-- Secci√≥n de Lote -->
                    <h3 class="section-subtitle">üìã Gesti√≥n de Lote</h3>
                    
                    <div class="mb-4">
                        <label class="form-label">Crear o Seleccionar Lote</label>
                        <select id="opcion-lote" class="form-select" required>
                            <option value="" disabled selected>Selecciona una opci√≥n</option>
                            <option value="crear">Crear Nuevo Lote</option>
                            <option value="seleccionar">Seleccionar Lote Existente</option>
                        </select>
                    </div>

                    <!-- Campos para CREAR lote -->
                    <div id="campos-crear-lote" class="hidden">
                        <div class="mb-4">
                            <label class="form-label">Nombre del Lote</label>
                            <input type="text" id="nombre-lote" class="form-control" placeholder="Ej: Lote A">
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Descripci√≥n del Lote</label>
                            <textarea id="descripcion-lote" class="form-control" placeholder="Ej: Lote para vacas lecheras" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Campos para SELECCIONAR lote -->
                    <div id="campos-seleccionar-lote" class="hidden">
                        <div class="mb-4">
                            <label class="form-label">Selecciona un Lote</label>
                            <div id="lista-lotes"></div>
                        </div>
                    </div>

                    <div class="divider"></div>

                    <!-- Secci√≥n de Vaca -->
                    <h3 class="section-subtitle">üêÑ Datos de la Vaca</h3>

                    <div class="mb-4">
                        <label class="form-label">Nombre de la Vaca</label>
                        <input type="text" id="nombre" class="form-control" placeholder="Ej: Margarita" required>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Raza</label>
                        <select id="raza" class="form-select" required>
                            <option value="" disabled selected>Selecciona una raza</option>
                            <option value="Jersey">Jersey</option>
                            <option value="Girolando">Girolando</option>
                            <option value="Gyr">Gyr</option>
                            <option value="Simmental">Simmental</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" id="peso" class="form-control" placeholder="Ej: 450" step="any" required>
                        </div>

                        <div class="col-md-6 mb-4">
                            <label class="form-label">Edad (a√±os)</label>
                            <input type="number" id="edad" class="form-control" placeholder="Ej: 3" required>
                        </div>
                    </div>
                    <div class="mb-4">
                            <label class="form-label">G√©nero</label>
                            <select id="genero" class="form-select" required>
                                <option value="" disabled selected>Selecciona un g√©nero</option>
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>

                        <!-- ETAPA CALCULADA -->
                        <div id="etapa-box" class="alert alert-success d-none">
                            <strong>Etapa:</strong> <span id="etapa-label"></span>
                        </div>

                    <div id="lactancia-container" class="mb-4 d-none">
                        <div class="form-check">
                            <input type="checkbox" id="lactando" class="form-check-input">
                            <label class="form-check-label" for="lactando">¬øEst√° lactando?</label>
                        </div>
                    </div>

                    <div id="produccion-container" class="mb-4 d-none">
                        <label class="form-label">Producci√≥n de Leche (L/d√≠a)</label>
                        <input type="number" id="leche" class="form-control" step="any">
                    </div>

                    <!-- BOT√ìN MOSTRAR/OCULTAR -->
                    <button type="button" id="toggle-avanzados" class="btn btn-outline-success mb-3">
                        Mostrar detalles avanzados
                    </button>

                    <div id="detalles-avanzados" class="d-none">

                        <div class="mb-3">
                            <label class="form-label">Fecha de nacimiento</label>
                            <input type="date" id="fecha-nacimiento" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Prop√≥sito</label>
                            <select id="proposito" class="form-select">
                                <option value="">Selecciona</option>
                                <option>Leche</option>
                                <option>Engorde</option>
                                <option>Venta</option>
                                <option>Reproducci√≥n</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Origen</label>
                            <select id="origen" class="form-select">
                                <option value="">Selecciona</option>
                                <option>Nacido en la finca</option>
                                <option>Comprado</option>
                                <option>Transferido</option>
                                <option>Regalo</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Padre</label>
                            <select id="padre" class="form-select">
                                <option value="">Ninguno</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Madre</label>
                            <select id="madre" class="form-select">
                                <option value="">Ninguna</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ID interno</label>
                            <input type="text" id="id-interno" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Chip ID</label>
                            <input type="text" id="chip-id" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Notas</label>
                            <textarea id="notas" class="form-control" rows="3"></textarea>
                        </div>

                        <div class="mb-3 d-none" id="estado-container">
                            <label class="form-label">Estado reproductivo</label>
                            <input type="text" id="estado-reproductivo" class="form-control">
                        </div>
                    </div>


                    <button type="submit" class="btn btn-success">
                        Guardar Registro
                    </button>
                </form>
            </div>
        </div>
    </main>

<!-- MODAL QR CODE -->
<div class="modal fade" id="modalQR" tabindex="-1" aria-labelledby="modalQRLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modal-qr">
      <div class="modal-header border-0">
        <h5 class="modal-title w-100 text-center" id="modalQRLabel">
          üì± Descarga la App BoviGestf
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-4">
        <p class="mb-4">Escanea el c√≥digo QR con tu dispositivo m√≥vil</p>
        
        <!-- üëá AQU√ç VA TU C√ìDIGO QR -->
        <div class="qr-container">
          <img src="img/qr-code-app.png" alt="QR Code" class="qr-image">
          <!-- Si no tienes imagen, puedes usar un servicio de generaci√≥n -->
          <!-- <img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=TU_ENLACE_APK" alt="QR Code" class="qr-image"> -->
        </div>

        <div class="download-info mt-4">
          <div class="info-badge">
            <span class="badge-icon">ü§ñ</span>
            <span class="badge-text">Android APK</span>
          </div>
          <p class="text-muted small mt-3 mb-0">
            O descarga directamente desde tu m√≥vil:
          </p>
          <a href="TU_ENLACE_DIRECTO_APK" class="btn btn-download-direct mt-2" download>
            <span>‚¨áÔ∏è</span> Descargar APK
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAzonIFbhlOnnIs9xG9Lb4uBJHLrhCi3qU",
            authDomain: "web-y-movil-agroncontrol.firebaseapp.com",
            projectId: "web-y-movil-agroncontrol",
            storageBucket: "web-y-movil-agroncontrol.firebasestorage.app",
            messagingSenderId: "180502593551",
            appId: "1:180502593551:web:f4ae5111ac99ec70fa237a",
            measurementId: "G-BJ9G9WSKNY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        /* =======================================
   üìå VARIABLES BASE
======================================= */
const form = document.getElementById("form-vaca");
const mensaje = document.getElementById("mensaje");
const opcionLote = document.getElementById("opcion-lote");
const camposCrearLote = document.getElementById("campos-crear-lote");
const camposSeleccionarLote = document.getElementById("campos-seleccionar-lote");
const listaLotes = document.getElementById("lista-lotes");

let currentUser = null;
let selectedLoteId = null;
let selectedLoteName = null;

/* =======================================
   üü¶ MOSTRAR CAMPOS SEG√öN OPCI√ìN LOTE
======================================= */
opcionLote.addEventListener("change", async () => {
    camposCrearLote.classList.add("hidden");
    camposSeleccionarLote.classList.add("hidden");
    selectedLoteId = null;

    if (opcionLote.value === "crear") {
        camposCrearLote.classList.remove("hidden");
    }

    if (opcionLote.value === "seleccionar") {
        camposSeleccionarLote.classList.remove("hidden");
        await cargarLotes();
    }
});

/* =======================================
   üì• CARGAR LOTES DEL USUARIO
======================================= */
async function cargarLotes() {
    listaLotes.innerHTML = "<p>Cargando lotes...</p>";

    const lotesRef = collection(db, "users", currentUser.uid, "lots");
    const lotesSnapshot = await getDocs(query(lotesRef));

    if (lotesSnapshot.empty) {
        listaLotes.innerHTML = "<p>No hay lotes creados.</p>";
        return;
    }

    listaLotes.innerHTML = "";

    lotesSnapshot.forEach((doc) => {
        const lote = doc.data();

        const item = document.createElement("div");
        item.className = "lote-item";
        item.innerHTML = `
            <h5>${lote.name}</h5>
            <p>${lote.description}</p>
        `;

        item.onclick = () => {
            document.querySelectorAll('.lote-item').forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedLoteId = doc.id;
            selectedLoteName = lote.name;
        };

        listaLotes.appendChild(item);
    });
}

/* =======================================
   üîê AUTENTICACI√ìN
======================================= */
onAuthStateChanged(auth, (user) => {
    if (!user) {
                mensaje.innerHTML = "<div class='alert-custom alert-danger-custom'>‚ö†Ô∏è Debes iniciar sesi√≥n para registrar vacas.</div>";
                form.style.display = "none";
                return;
            }

            currentUser = user;
            form.style.display = "block";
            mensaje.innerHTML = "<div class='alert-custom alert-success-custom'>‚úÖ Bienvenido, puedes registrar tus vacas</div>";

    cargarPadresMadres();
});

/* =======================================
   üéõ MOSTRAR/OCULTAR DETALLES AVANZADOS
======================================== */
const toggleBtn = document.getElementById("toggle-avanzados");
const detalles = document.getElementById("detalles-avanzados");

toggleBtn.addEventListener("click", () => {
    detalles.classList.toggle("d-none");

    if (detalles.classList.contains("d-none")) {
        toggleBtn.textContent = "Mostrar detalles avanzados";
    } else {
        toggleBtn.textContent = "Ocultar detalles avanzados";
    }
});


/* =======================================
   üêÑ CARGAR PADRES Y MADRES EXISTENTES
======================================= */
async function cargarPadresMadres() {
    if (!currentUser) return;

    const padreSel = document.getElementById("padre");
    const madreSel = document.getElementById("madre");

    padreSel.innerHTML = "<option value=''>Ninguno</option>";
    madreSel.innerHTML = "<option value=''>Ninguna</option>";

    const cowsRef = collection(db, "users", currentUser.uid, "cows");
    const snap = await getDocs(cowsRef);

    snap.forEach(doc => {
    const cow = doc.data();

    // SOLO MACHOS PARA PADRE
    if (cow.gender === "Macho") {
        padreSel.innerHTML += `
            <option value="${doc.id}" data-name="${cow.name}">
                ${cow.name}
            </option>`;
    }

    // SOLO HEMBRAS PARA MADRE
    if (cow.gender === "Hembra") {
        madreSel.innerHTML += `
            <option value="${doc.id}" data-name="${cow.name}">
                ${cow.name}
            </option>`;
    }
});

}

/* =======================================
   üßÆ CALCULAR ETAPA AUTOM√ÅTICA
======================================= */
const edad = document.getElementById("edad");
const genero = document.getElementById("genero");
const etapaBox = document.getElementById("etapa-box");
const etapaLabel = document.getElementById("etapa-label");

function calcularEtapa() {
    if (!edad.value || !genero.value) return etapaBox.classList.add("d-none");

    let e = "";
    const age = parseFloat(edad.value);

    if (genero.value === "Macho") {
        if (age < 1) e = "Ternero";
        else if (age < 2) e = "Novillo";
        else e = "Toro";
    } else {
        if (age < 1) e = "Ternera";
        else if (age < 2) e = "Novilla";
        else e = "Vaca adulta";
    }

    etapaLabel.textContent = e;
    etapaBox.classList.remove("d-none");
}

edad.addEventListener("input", calcularEtapa);
genero.addEventListener("change", calcularEtapa);

/* =======================================
   üçº MOSTRAR CAMPOS: LACTANCIA Y PRODUCCI√ìN
======================================= */
const lactanciaContainer = document.getElementById("lactancia-container");
const produccionContainer = document.getElementById("produccion-container");
const lactandoCheck = document.getElementById("lactando");

genero.addEventListener("change", () => {
    if (genero.value === "Hembra") lactanciaContainer.classList.remove("d-none");
    else {
        lactanciaContainer.classList.add("d-none");
        lactandoCheck.checked = false;
        produccionContainer.classList.add("d-none");
    }
});

lactandoCheck.addEventListener("change", () => {
    produccionContainer.classList.toggle("d-none", !lactandoCheck.checked);
});

const estadoContainer = document.getElementById("estado-container");

genero.addEventListener("change", () => {

    // manejo lactancia ya existente...
    if (genero.value === "Hembra") {
        lactanciaContainer.classList.remove("d-none");
        estadoContainer.classList.remove("d-none"); // üëà MOSTRAR ESTADO
    } else {
        lactanciaContainer.classList.add("d-none");
        estadoContainer.classList.add("d-none");   // üëà OCULTAR ESTADO
        lactandoCheck.checked = false;
        produccionContainer.classList.add("d-none");
    }

});


/* =======================================
   üéØ GUARDAR VACA
======================================= */
form.addEventListener("submit", async (e) => {
    e.preventDefault();

    try {

        /* VALIDAR LOTE */
        if (opcionLote.value === "crear") {
            const name = document.getElementById("nombre-lote").value;
            const desc = document.getElementById("descripcion-lote").value;

            const docRef = await addDoc(collection(db, "users", currentUser.uid, "lots"), {
                name,
                description: desc,
                userId: currentUser.uid,
                createdAt: new Date()
            });

            selectedLoteId = docRef.id;
            selectedLoteName = name;
        }

        if (!selectedLoteId) {
            mensaje.innerHTML = `<div class="alert-danger-custom">Debes seleccionar un lote.</div>`;
            return;
        }
        const padreSelect = document.getElementById("padre");
        const madreSelect = document.getElementById("madre");

        const fatherId = padreSelect.value || null;
        const fatherName =
            padreSelect.options[padreSelect.selectedIndex]?.dataset.name || null;

        const motherId = madreSelect.value || null;
        const motherName =
        madreSelect.options[madreSelect.selectedIndex]?.dataset.name || null;


        /* GUARDAR LA VACA */
        const vaca = {
            name: document.getElementById("nombre").value,
            breed: document.getElementById("raza").value,
            weight: parseFloat(document.getElementById("peso").value),
            age: parseInt(document.getElementById("edad").value),
            gender: document.getElementById("genero").value,
            milkProduction: parseFloat(document.getElementById("leche").value) || 0,
            isLactating: lactandoCheck.checked,
            lotId: selectedLoteId,
            lotName: selectedLoteName,
            fatherId: fatherId,
            fatherName: fatherName,
            motherId: motherId,
            motherName: motherName,
            birthDate: document.getElementById("fecha-nacimiento").value || null,
            purpose: document.getElementById("proposito").value || "",
            origin: document.getElementById("origen").value || "",
            internalId: document.getElementById("id-interno").value || "",
            chipId: document.getElementById("chip-id").value || "",
            notes: document.getElementById("notas").value || "",
            reproductiveStatus: document.getElementById("estado-reproductivo").value || "",
            createdAt: new Date()
        };

        await addDoc(collection(db, "users", currentUser.uid, "cows"), vaca);

        mensaje.innerHTML = "<div class='alert-custom alert-success-custom'>‚úÖ Vaca registrada con √©xito en el lote: " + selectedLoteName + "</div>";
                form.reset();
                camposCrearLote.classList.add("hidden");
                camposSeleccionarLote.classList.add("hidden");
                
                setTimeout(() => {
                    mensaje.innerHTML = "<div class='alert-custom alert-success-custom'>‚úÖ Bienvenido, puedes registrar tus vacas</div>";
                }, 3000);
            } catch (error) {
                console.error("Error al guardar vaca:", error);
                mensaje.innerHTML = "<div class='alert-custom alert-danger-custom'>‚ùå Error al guardar la vaca. Intenta nuevamente.</div>";
            }
        });

</script>

</body>
</html>